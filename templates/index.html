<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Huiber</title>
    <link rel="icon" type="image/png" href="/static/logo.png" />
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <style>
      /* --- –°—Ç–∏–ª–∏ CSS --- */
      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin: 0;
          background: url('/static/background.png') no-repeat center center fixed;
          background-size: cover;
          display: flex;
          flex-direction: column;
          align-items: center;
          color: #333; /* –ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
      }
      h1 {
          font-size: 28px; /* –ù–µ–º–Ω–æ–≥–æ –∫—Ä—É–ø–Ω–µ–µ */
          color: #4a148c; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
          margin: 25px 0;
          display: flex;
          align-items: center;
          justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
          width: 100%;
          position: relative; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è */
          text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }
      h1 button#profile-btn {
           font-size: 16px; /* –†–∞–∑–º–µ—Ä –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è */
           margin-left: 15px;
           padding: 8px 12px;
           background-color: #e1bee7; /* –°–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ñ–æ–Ω */
           color: #4a148c;
           border: none;
           border-radius: 20px; /* –°–∏–ª—å–Ω–æ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
           cursor: pointer;
           transition: background-color 0.2s ease;
           box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      h1 button#profile-btn:hover {
          background-color: #ce93d8; /* –¢–µ–º–Ω–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
      }

      #chat-container, #username-form, #profile-modal, #users-list, #call-modal, #call-window {
          width: 100%;
          max-width: 650px; /* –ù–µ–º–Ω–æ–≥–æ —à–∏—Ä–µ */
          background: rgba(255, 255, 255, 0.92); /* –ß—É—Ç—å –º–µ–Ω–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
          border: 1px solid #ce93d8; /* –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
          border-radius: 18px; /* –ë–æ–ª–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); /* –£—Å–∏–ª–µ–Ω–Ω–∞—è —Ç–µ–Ω—å */
          margin-bottom: 20px; /* –ë–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
          display: flex; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
          flex-direction: column; /* –≠–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∏–¥—É—Ç —Å—Ç–æ–ª–±–∏–∫–æ–º */
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ) */
      #username-form, #profile-modal, #call-modal, #call-window {
          padding: 35px;
          text-align: center;
          position: fixed; /* –û—Å—Ç–∞—é—Ç—Å—è –º–æ–¥–∞–ª—å–Ω—ã–º–∏ */
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          display: none; /* –°–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
          z-index: 1000;
          width: 90%;
          max-width: 450px; /* –ú–∞–∫—Å —à–∏—Ä–∏–Ω–∞ –º–æ–¥–∞–ª–æ–∫ */
           flex-direction: column; /* –≠–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ç–æ–ª–±–∏–∫–æ–º */
           align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã */
      }
       #username-form h3, #profile-modal h3, #call-modal h3, #call-window h3 {
           margin-top: 0;
           margin-bottom: 20px;
           color: #6a1b9a; /* –¢–µ–º–Ω–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
           font-size: 20px;
       }
        #username-form p {
           margin-bottom: 15px;
           color: #555;
        }

       /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª–∫–∞—Ö */
       #username, #avatar, #new-username, #new-avatar {
          padding: 12px 15px;
          border: 1px solid #ce93d8;
          border-radius: 8px;
          width: calc(100% - 32px); /* –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –º–∏–Ω—É—Å –ø–∞–¥–¥–∏–Ω–≥–∏ */
          margin-bottom: 15px;
          box-sizing: border-box;
          font-size: 15px;
       }
       /* –°—Ç–∏–ª–∏ –¥–ª—è file input label */
       label.file-input-label {
           display: inline-block;
           padding: 10px 15px;
           background-color: #f3e5f5;
           color: #7b1fa2;
           border: 1px dashed #ce93d8;
           border-radius: 8px;
           cursor: pointer;
           margin-bottom: 15px;
           transition: background-color 0.2s ease;
       }
       label.file-input-label:hover {
           background-color: #e1bee7;
       }
       /* –ü—Ä–µ–≤—å—é –∞–≤–∞—Ç–∞—Ä–∞ */
       img.avatar-preview {
           max-width: 100px;
           max-height: 100px;
           border-radius: 50%;
           margin-bottom: 15px;
           display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ–∫–∞ –Ω–µ—Ç —Ñ–∞–π–ª–∞ */
           border: 2px solid #ce93d8;
           padding: 3px;
           background-color: white;
       }

       /* –ö–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª–∫–∞—Ö */
       #save-btn, #save-profile-btn, #accept-call-btn, #reject-call-btn, #end-call-btn, .modal-cancel-btn {
          background-color: #ab47bc; /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
          color: white;
          border: none;
          padding: 12px 25px; /* –ö—Ä—É–ø–Ω–µ–µ –∫–Ω–æ–ø–∫–∏ */
          border-radius: 8px;
          cursor: pointer;
          margin: 10px 5px 0;
          font-size: 15px;
          font-weight: 500;
          transition: background-color 0.2s ease, box-shadow 0.2s ease;
           box-shadow: 0 2px 4px rgba(0,0,0,0.1);
       }
       #save-btn:hover, #save-profile-btn:hover, #accept-call-btn:hover, #reject-call-btn:hover, #end-call-btn:hover, .modal-cancel-btn:hover {
          background-color: #8e24aa; /* –¢–µ–º–Ω–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
           box-shadow: 0 3px 6px rgba(0,0,0,0.15);
       }
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∫–Ω–æ–ø–æ–∫ –∑–≤–æ–Ω–∫–∞ */
        #accept-call-btn { background-color: #4caf50; } /* –ó–µ–ª–µ–Ω—ã–π */
        #accept-call-btn:hover { background-color: #388e3c; }
        #reject-call-btn, #end-call-btn { background-color: #f44336; } /* –ö—Ä–∞—Å–Ω—ã–π */
        #reject-call-btn:hover, #end-call-btn:hover { background-color: #d32f2f; }
        .modal-cancel-btn { background-color: #9e9e9e; } /* –°–µ—Ä—ã–π –¥–ª—è –æ—Ç–º–µ–Ω—ã */
        .modal-cancel-btn:hover { background-color: #757575; }


      /* --- –ß–∞—Ç --- */
      #chat {
          flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
          height: 450px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ */
          overflow-y: auto;
          padding: 20px;
          background: #f3e5f5; /* –°–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ñ–æ–Ω —á–∞—Ç–∞ */
          border-bottom: 1px solid #e1bee7; /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
          /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ö–Ω–∏—Ö —É–≥–ª–æ–≤, –µ—Å–ª–∏ input-area –≤–Ω–∏–∑—É */
           border-top-left-radius: 18px;
           border-top-right-radius: 18px;
           display: flex;
           flex-direction: column; /* –°–æ–æ–±—â–µ–Ω–∏—è –∏–¥—É—Ç —Å—Ç–æ–ª–±–∏–∫–æ–º */
      }
       #chat:empty::before { /* –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —á–∞—Ç–∞ */
           content: "–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...";
           display: block;
           text-align: center;
           color: #7b1fa2;
           padding: 50px 0;
           font-style: italic;
       }

      /* –°–æ–æ–±—â–µ–Ω–∏—è */
      .message {
          margin-bottom: 12px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ */
          padding: 10px 15px;
          border-radius: 18px; /* –ë–æ–ª–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
          max-width: 78%; /* –ú–∞–∫—Å —à–∏—Ä–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
          word-wrap: break-word;
          display: flex; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
          align-items: flex-start; /* –ê–≤–∞—Ç–∞—Ä –∏ —Ç–µ–∫—Å—Ç —Å–≤–µ—Ä—Ö—É */
          line-height: 1.45; /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å */
          position: relative; /* –î–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
      }
      .my-message {
          background-color: #ab47bc; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è —Å–≤–æ–∏—Ö */
          color: white;
          margin-left: auto; /* –°–ø—Ä–∞–≤–∞ */
          border-bottom-right-radius: 5px; /* –î—Ä—É–≥–æ–π —É–≥–æ–ª –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∏—è */
           flex-direction: row-reverse; /* –ê–≤–∞—Ç–∞—Ä —Å–ø—Ä–∞–≤–∞ */
      }
      .other-message {
          background-color: #e1bee7; /* –°–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è —á—É–∂–∏—Ö */
          color: #333; /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç */
          margin-right: auto; /* –°–ª–µ–≤–∞ */
          border-bottom-left-radius: 5px;
           flex-direction: row; /* –ê–≤–∞—Ç–∞—Ä —Å–ª–µ–≤–∞ */
      }
      .avatar {
          width: 35px; /* –ö—Ä—É–ø–Ω–µ–µ –∞–≤–∞—Ç–∞—Ä */
          height: 35px;
          border-radius: 50%;
          border: 1px solid rgba(0, 0, 0, 0.1);
          margin: 0 10px; /* –û—Ç—Å—Ç—É–ø—ã –≤–æ–∫—Ä—É–≥ –∞–≤–∞—Ç–∞—Ä–∞ */
          flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å –∞–≤–∞—Ç–∞—Ä */
      }
      .my-message .avatar { margin-left: 10px; margin-right: 0; } /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –¥–ª—è —Å–≤–æ–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ */
      .other-message .avatar { margin-right: 10px; margin-left: 0; }

       .message-content-wrapper {
           display: flex;
           flex-direction: column; /* –ò–º—è –∏ —Ç–µ–∫—Å—Ç/–∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å—Ç–æ–ª–±–∏–∫–æ–º */
           flex-grow: 1; /* –ó–∞–Ω–∏–º–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
       }
      .username {
          font-weight: 600;
          font-size: 13px; /* –ú–µ–Ω—å—à–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
          margin-bottom: 3px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –∏–º–µ–Ω–µ–º */
          color: rgba(0, 0, 0, 0.6); /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ü–≤–µ—Ç –∏–º–µ–Ω–∏ */
      }
       /* –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
      .my-message .username {
           color: rgba(255, 255, 255, 0.8); /* –°–≤–µ—Ç–ª–æ–µ –∏–º—è */
           text-align: right; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
      }
       .message-text {
          font-size: 15px; /* –†–∞–∑–º–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
       }
      .message img.content-img {
          max-width: 100%;
          max-height: 300px;
          object-fit: cover;
          border-radius: 10px;
          margin-top: 8px;
          cursor: pointer;
           border: 1px solid rgba(0,0,0,0.1);
      }
       /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
      .delete-btn {
          background: none;
          border: none;
          color: rgba(255, 255, 255, 0.6); /* –ë–µ–ª—ã–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –¥–ª—è —Å–≤–æ–∏—Ö */
          font-weight: normal;
          position: absolute; /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
          top: 5px;
          right: 8px;
          cursor: pointer;
          display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
          font-size: 16px;
          padding: 2px;
          line-height: 1;
           opacity: 0.7;
           transition: opacity 0.2s ease;
      }
       /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */
      .my-message:hover .delete-btn {
          display: block;
      }
       .delete-btn:hover {
           opacity: 1.0;
           color: #ffcdd2; /* –°–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
       }
       /* –î–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞ */
       .other-message .delete-btn { display: none !important; }


      /* --- –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ --- */
      #input-area {
          display: flex;
          padding: 15px 20px;
          border-top: 1px solid #ce93d8;
          align-items: center;
          background: rgba(255, 255, 255, 0.95);
           /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∏–∂–Ω–∏—Ö —É–≥–ª–æ–≤ */
           border-bottom-left-radius: 18px;
           border-bottom-right-radius: 18px;
      }
      #message {
          flex: 1;
          padding: 12px 18px;
          border: 1px solid #ce93d8;
          border-radius: 25px; /* –°–∏–ª—å–Ω–æ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ */
          outline: none;
          font-size: 15px;
          background: #fff;
          margin-right: 10px;
           resize: none; /* –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ */
           min-height: 20px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ */
           max-height: 100px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–æ–∫ */
           overflow-y: auto; /* –î–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –º–Ω–æ–≥–æ */
      }
      #input-area button {
          background: none;
          border: none;
          color: #7b1fa2; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è –∏–∫–æ–Ω–æ–∫ */
          font-size: 24px; /* –ö—Ä—É–ø–Ω–µ–µ –∏–∫–æ–Ω–∫–∏ */
          margin-left: 8px;
          cursor: pointer;
          padding: 5px;
          transition: color 0.2s ease, transform 0.1s ease;
           line-height: 1; /* –£–±—Ä–∞—Ç—å –ª–∏—à–Ω—é—é –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫–∏ */
      }
      #input-area button:hover {
          color: #4a148c; /* –¢–µ–º–Ω–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
      }
       #input-area button:active {
           transform: scale(0.9); /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
       }
       #send-btn {
           font-weight: bold;
       }
       /* –ü—Ä–µ–≤—å—é –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ */
      #message-preview-container {
           padding: 0 20px 10px;
           text-align: left; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤–ª–µ–≤–æ */
           display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
           background: rgba(255, 255, 255, 0.95); /* –¢–æ—Ç –∂–µ —Ñ–æ–Ω, —á—Ç–æ –∏ —É input-area */
      }
       #message-preview {
           max-width: 80px;
           max-height: 80px;
           border-radius: 5px;
           margin-top: 5px;
           border: 1px solid #eee;
           vertical-align: middle; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å—Ç—Ä–æ–∫–∏ */
       }
       #message-preview-container button { /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –ø—Ä–µ–≤—å—é */
           font-size: 16px; /* –†–∞–∑–º–µ—Ä –∫—Ä–µ—Å—Ç–∏–∫–∞ */
           background: none;
           border: none;
           color: #aaa;
           cursor: pointer;
           padding: 0 5px;
           margin-left: 5px;
           vertical-align: middle;
       }
        #message-preview-container button:hover {
           color: #f44336; /* –ö—Ä–∞—Å–Ω—ã–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }

      /* --- –í—ã–±–æ—Ä —ç–º–æ–¥–∑–∏ --- */
      #emoji-picker {
          display: none;
          position: absolute;
          bottom: 75px; /* –í—ã—à–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ */
          right: 20px;
          background: white;
          border: 1px solid #ce93d8;
          padding: 15px;
          border-radius: 10px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
          z-index: 1001; /* –í—ã—à–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
           width: auto; /* –ê–≤—Ç–æ —à–∏—Ä–∏–Ω–∞ */
           max-width: 300px; /* –ú–∞–∫—Å —à–∏—Ä–∏–Ω–∞ */
      }
      .emoji {
          font-size: 26px; /* –ö—Ä—É–ø–Ω–µ–µ —ç–º–æ–¥–∑–∏ */
          cursor: pointer;
          margin: 4px 6px;
          display: inline-block;
          transition: transform 0.1s ease;
      }
      .emoji:hover {
          transform: scale(1.2); /* –≠—Ñ—Ñ–µ–∫—Ç –∑—É–º–∞ */
      }

      /* --- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π --- */
      #users-list {
          padding: 20px 25px;
          margin-top: 0; /* –£–±–∏—Ä–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø, –µ—Å–ª–∏ —á–∞—Ç –≤–∏–¥–µ–Ω */
           /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∏–∂–Ω–∏—Ö —É–≥–ª–æ–≤, –µ—Å–ª–∏ –æ–Ω –ø–æ–¥ —á–∞—Ç–æ–º */
           border-top-left-radius: 0;
           border-top-right-radius: 0;
           border-top: 1px solid #e1bee7; /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
           background: rgba(255, 255, 255, 0.9); /* –ß—É—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ */
            border-bottom-left-radius: 18px; /* –°–∫—Ä—É–≥–ª—è–µ–º –∏ –Ω–∏–∑ */
            border-bottom-right-radius: 18px;
      }
      #users-list h3 {
          margin-top: 0;
          margin-bottom: 15px;
          color: #6a1b9a;
          border-bottom: 1px solid #e1bee7;
          padding-bottom: 10px;
          font-size: 18px; /* –†–∞–∑–º–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ */
      }
       #users-content:empty::before { /* –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ */
           content: "–î—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç –æ–Ω–ª–∞–π–Ω";
           display: block;
           text-align: center;
           color: #7b1fa2;
           padding: 20px 0;
           font-style: italic;
       }
      .user-item {
          display: flex;
          align-items: center;
          margin-bottom: 12px;
          padding: 10px;
          border-radius: 10px;
          transition: background-color 0.2s ease;
          position: relative; /* –î–ª—è –∫–Ω–æ–ø–∫–∏ –∑–≤–æ–Ω–∫–∞ */
      }
      .user-item:hover {
          background-color: #f3e5f5;
      }
      .user-item img.avatar { /* –°—Ç–∏–ª–∏ –∞–≤–∞—Ç–∞—Ä–∞ –≤ —Å–ø–∏—Å–∫–µ */
          width: 45px; /* –ö—Ä—É–ø–Ω–µ–µ –∞–≤–∞—Ç–∞—Ä –≤ —Å–ø–∏—Å–∫–µ */
          height: 45px;
          margin-right: 15px;
           border: 2px solid transparent; /* –ì—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ */
      }
        /* –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
       .user-item img.avatar.online { border-color: #4caf50; /* –ó–µ–ª–µ–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –æ–Ω–ª–∞–π–Ω–∞ */}
       .user-item img.avatar.offline { border-color: #ccc; /* –°–µ—Ä–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –æ—Ñ–ª–∞–π–Ω–∞ */}

       .user-item .user-info {
           flex-grow: 1;
       }
       .user-item span.username-in-list { /* –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ */
           font-size: 15px;
           font-weight: 500;
           color: #4a148c;
           display: block; /* –ò–º—è –Ω–∞ —Å–≤–æ–µ–π —Å—Ç—Ä–æ–∫–µ */
       }
       .user-item .last-seen {
           font-size: 11px;
           color: #7b1fa2;
           display: block;
           margin-top: 2px;
       }
        .user-item .last-seen.online { color: #4caf50; font-weight: 500; } /* –ó–µ–ª–µ–Ω—ã–π —Å—Ç–∞—Ç—É—Å */
        .user-item .last-seen.offline { color: #9e9e9e; } /* –°–µ—Ä—ã–π —Å—Ç–∞—Ç—É—Å */

       /* –ö–Ω–æ–ø–∫–∞ –∑–≤–æ–Ω–∫–∞ */
       .call-user-btn {
          background-color: #4caf50;
          color: white;
          padding: 8px 10px; /* –ú–µ–Ω—å—à–µ –ø–∞–¥–¥–∏–Ω–≥ */
          border-radius: 50%; /* –ö—Ä—É–≥–ª–∞—è –∫–Ω–æ–ø–∫–∞ */
          font-size: 18px; /* –†–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ –∑–≤–æ–Ω–∫–∞ */
          margin-left: 15px; /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ */
          cursor: pointer;
          border: none;
          transition: background-color 0.2s ease, transform 0.1s ease;
           line-height: 1; /* –£–±—Ä–∞—Ç—å –ª–∏—à–Ω—é—é –≤—ã—Å–æ—Ç—É */
           flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å –∫–Ω–æ–ø–∫—É */
       }
       .call-user-btn:hover {
          background-color: #388e3c;
       }
        .call-user-btn:active {
           transform: scale(0.9);
       }


      /* --- –û–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ --- */
      #call-window {
           background-color: #e1f5fe; /* –°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω */
           border-color: #81d4fa;
      }
       #call-window h3 {
           color: #0277bd;
       }
       #call-participants {
           margin: 15px 0;
           font-weight: 500;
           color: #03a9f4;
           min-height: 20px; /* –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –º–µ—Å—Ç–æ */
       }
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏/—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è */
       .connecting-indicator {
           display: none; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ JS */
           margin: 10px auto;
           border: 5px solid #f3f3f3; /* –°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
           border-top: 5px solid #03a9f4; /* –°–∏–Ω–∏–π */
           border-radius: 50%;
           width: 35px;
           height: 35px;
           animation: spin 1.2s linear infinite;
       }
        @keyframes spin {
           0% { transform: rotate(0deg); }
           100% { transform: rotate(360deg); }
       }

        /* –°–∫—Ä—ã—Ç—ã–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç */
        #remote-audio {
           display: none;
        }

       /* --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π --- */
       #imageModal {
           display: none;
           position: fixed;
           z-index: 2000; /* –í—ã—à–µ –≤—Å–µ–≥–æ */
           left: 0;
           top: 0;
           width: 100%;
           height: 100%;
           overflow: auto;
           background-color: rgba(0,0,0,0.85); /* –¢–µ–º–Ω–µ–µ —Ñ–æ–Ω */
           cursor: pointer; /* –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –º–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è */
       }
       #modalImage {
           margin: auto;
           display: block;
           max-width: 90%;
           max-height: 85%;
           position: absolute;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
            border-radius: 5px;
            cursor: default; /* –û–±—ã—á–Ω—ã–π –∫—É—Ä—Å–æ—Ä –Ω–∞ —Å–∞–º–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ */
       }
       #imageModal .close-modal-btn { /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
           position: absolute;
           top: 15px;
           right: 30px;
           color: #f1f1f1;
           font-size: 45px;
           font-weight: bold;
           cursor: pointer;
           transition: color 0.2s ease;
           line-height: 1;
       }
       #imageModal .close-modal-btn:hover {
           color: #bbb;
       }
    </style>
  </head>
  <body>
    <h1>Huiber <button id="profile-btn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button></h1>

    <div id="username-form" style="display: none;">
      <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
      <p>–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:</p>
      <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è" required />
      <br />
      <label for="avatar" class="file-input-label">üì∑ –í—ã–±—Ä–∞—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
      <input
        type="file"
        id="avatar"
        accept="image/*"
        style="display: none;"
        required
      />
      <br />
      <img
        id="avatar-preview"
        src="#"
        alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∞"
        class="avatar-preview"
      />
      <br />
      <button id="save-btn" onclick="setUsername()">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
    </div>

    <div id="profile-modal" style="display: none;">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
      <input type="text" id="new-username" placeholder="–ù–æ–≤–æ–µ –∏–º—è" />
      <br />
      <label for="new-avatar" class="file-input-label">üì∑ –°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
      <input
        type="file"
        id="new-avatar"
        accept="image/*"
        style="display: none;"
      />
      <br />
      <img
        id="new-avatar-preview"
        src="#"
        alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–æ–≤–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞"
        class="avatar-preview"
      />
      <br />
      <button id="save-profile-btn" onclick="updateProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button
        class="modal-cancel-btn"
        onclick="document.getElementById('profile-modal').style.display = 'none'"
      >
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>

    <div id="call-modal" style="display: none;">
      <h3 id="call-text">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...</h3>
      <p style="font-size: 40px;">üìû</p>
      <button id="accept-call-btn" onclick="acceptCall()">–ü—Ä–∏–Ω—è—Ç—å</button>
      <button id="reject-call-btn" onclick="rejectCall()">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
    </div>

    <div id="call-window" style="display: none;">
      <h3>üîä –ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫</h3>
      <div class="connecting-indicator" id="connecting-indicator"></div>
      <p id="call-participants">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</p>
      <audio
        id="remote-audio"
        autoplay
        playsinline
        style="display: none;"
      ></audio>
      <button id="end-call-btn" onclick="endCall()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

    <div id="chat-container" style="display: none;">
      <div id="chat"></div>
      <div id="input-area">
        <input type="text" id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="emoji-btn" title="–≠–º–æ–¥–∑–∏">üòä</button>
        <input
          type="file"
          id="file-input"
          accept="image/*"
          style="display: none;"
          onchange="previewImage(event, 'message-preview-container')"
        />
        <button
          id="file-btn"
          onclick="document.getElementById('file-input').click()"
          title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ"
        >
          üì∑
        </button>
        <button id="send-btn" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
          ‚û§
        </button>
      </div>
      <div id="message-preview-container">
        <img id="message-preview" src="#" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" />
        <button onclick="clearMessagePreview()" title="–£–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
          ‚úñ
        </button>
      </div>
      <div id="emoji-picker">
        <span class="emoji" onclick="addEmoji('üòä')">üòä</span>
        <span class="emoji" onclick="addEmoji('üòÇ')">üòÇ</span>
        <span class="emoji" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="emoji" onclick="addEmoji('üëç')">üëç</span>
        <span class="emoji" onclick="addEmoji('üò¢')">üò¢</span>
        <span class="emoji" onclick="addEmoji('ü§î')">ü§î</span>
        <span class="emoji" onclick="addEmoji('üéâ')">üéâ</span>
        <span class="emoji" onclick="addEmoji('üî•')">üî•</span>
        <span class="emoji" onclick="addEmoji('üëã')">üëã</span>
        <span class="emoji" onclick="addEmoji('üôè')">üôè</span>
        <span class="emoji" onclick="addEmoji('üëÄ')">üëÄ</span>
        <span class="emoji" onclick="addEmoji('‚ú®')">‚ú®</span>
        <span class="emoji" onclick="addEmoji('—ù')">—ù</span>
      </div>
    </div>

    <div id="users-list" style="display: none;">
      <h3>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω</h3>
      <div id="users-content"></div>
    </div>

    <audio id="ringtone" src="/static/ringtone.mp3" loop></audio>

    <div id="imageModal" onclick="closeImageModal()">
      <span class="close-modal-btn" onclick="closeImageModal(event)"
        >&times;</span
      >
      <img id="modalImage" onclick="event.stopPropagation()" />
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script>
      // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
      const socket = io(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É, –æ—Ç–∫—É–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
      let username = localStorage.getItem('username');
      let avatar = localStorage.getItem('avatar');
      let users = {}; // –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

      // WebRTC Globals
      let peerConnection;
      let localStream;
      let currentTarget = null; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä–æ–º—É –∑–≤–æ–Ω–∏–º –∏–ª–∏ –∫—Ç–æ –∑–≤–æ–Ω–∏—Ç –Ω–∞–º
      let receivedOffer = null; // –•—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞ –ø—Ä–∏ –≤—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ
      const ringtone = document.getElementById('ringtone');
      const remoteAudio = document.getElementById('remote-audio');

      // ICE Server Configuration (STUN)
      const configuration = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
             // –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ TURN —Å–µ—Ä–≤–µ—Ä–∞
             // { urls: 'turn:your.turn.server:port', username: 'user', credential: 'password' }
        ]
      };

      // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
      document.addEventListener('DOMContentLoaded', () => {
          if (!username || !avatar) {
              showLogin();
          } else {
              showChat();
              initializeChat();
          }
      });

      function showLogin() {
          hideElement('chat-container');
          hideElement('users-list');
          showElement('username-form');
          // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–µ–≤—å—é –¥–ª—è —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
          document.getElementById('avatar').onchange = (event) => {
              previewImage(event, 'avatar-preview'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –ø—Ä–µ–≤—å—é
          };
      }

       function showChat() {
           hideElement('username-form');
           showElement('chat-container');
           showElement('users-list'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–º–µ—Å—Ç–µ —Å —á–∞—Ç–æ–º
           document.getElementById('users-list').style.marginTop = '0'; // –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø —É —Å–ø–∏—Å–∫–∞
       }

       // –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
       function showElement(id) {
           const el = document.getElementById(id);
           if (el) el.style.display = 'flex'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            // –î–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ–º block –∏–ª–∏ flex –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∏–ª–µ–π
           if (['username-form', 'profile-modal', 'call-modal', 'call-window', 'imageModal'].includes(id)) {
                el.style.display = 'flex'; // –ú–æ–¥–∞–ª–∫–∏ —Ç–æ–∂–µ flex
           }
       }
       function hideElement(id) {
           const el = document.getElementById(id);
           if (el) el.style.display = 'none';
       }


      function initializeChat() {
          console.log("Initializing chat for user:", username);
          updateMessageStyles(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
          socket.connect(); // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ–∫–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω
          socket.emit('user_active', { username: username, avatar: avatar });
          socket.emit('get_users');
          socket.emit('get_messages'); // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
          requestNotificationPermission();
          setupGlobalListeners(); // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–∫–µ—Ç–∞
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –ø–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
          startActivityPing();
      }

       let activityPingInterval;
       function startActivityPing() {
           clearInterval(activityPingInterval); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –µ—Å—Ç—å
           activityPingInterval = setInterval(() => {
               if (socket.connected && username) {
                   // console.log("Sending periodic user_active ping");
                   socket.emit('user_active', { username: username, avatar: avatar });
               }
           }, 30000); // –ü–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
       }


      // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–í—Ö–æ–¥, –ü—Ä–æ—Ñ–∏–ª—å) ---
      function setUsername() {
          const usernameInput = document.getElementById('username');
          const avatarInput = document.getElementById('avatar');
          const potentialUsername = usernameInput.value.trim();
          const avatarFile = avatarInput.files[0];

          if (potentialUsername && avatarFile) {
              // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä)
               if (potentialUsername.length < 3 || potentialUsername.length > 15) {
                    alert("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤.");
                    return;
               }
               if (!/^[a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å_-]+$/.test(potentialUsername)) {
                    alert("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _ –∏ -.");
                    return;
               }


              const formData = new FormData();
              formData.append('file', avatarFile);

              // –ò–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
              const saveBtn = document.getElementById('save-btn');
              saveBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
              saveBtn.disabled = true;

              fetch('/upload', { method: 'POST', body: formData })
                  .then(response => {
                      if (!response.ok) throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
                      return response.text();
                  })
                  .then(filename => {
                       username = potentialUsername; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –∏–º—è
                       avatar = filename;
                       localStorage.setItem('username', username);
                       localStorage.setItem('avatar', avatar);
                       showChat();
                       initializeChat();
                  })
                  .catch(error => {
                      console.error('Error setting username/avatar:', error);
                      alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`);
                  })
                  .finally(() => {
                       // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                       saveBtn.textContent = '–í–æ–π—Ç–∏ –≤ —á–∞—Ç';
                       saveBtn.disabled = false;
                  });
          } else {
              alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä.');
          }
      }

      function updateProfile() {
         // ... (–∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ updateProfile –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ) ...
          const newUsernameInput = document.getElementById('new-username');
          const newAvatarInput = document.getElementById('new-avatar');
          const newUsername = newUsernameInput.value.trim();
          const newAvatarFile = newAvatarInput.files[0];

          let updateData = {};
          let needsReload = false;
          const oldUsername = localStorage.getItem('username');

           // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∏–º–µ–Ω–∏, –µ—Å–ª–∏ –æ–Ω–æ –≤–≤–µ–¥–µ–Ω–æ
           if (newUsername && newUsername !== oldUsername) {
                if (newUsername.length < 3 || newUsername.length > 15) {
                    alert("–ù–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤.");
                    return;
                }
                if (!/^[a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å_-]+$/.test(newUsername)) {
                    alert("–ù–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _ –∏ -.");
                    return;
                }
                 updateData.username = newUsername;
                 needsReload = true; // –ò–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å - –Ω—É–∂–Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
           }

          const handleUpdate = (updatedAvatarFilename = null) => {
              if (updateData.username) {
                  localStorage.setItem('username', updateData.username);
                  username = updateData.username; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
              }
              if (updatedAvatarFilename) {
                  updateData.avatar = updatedAvatarFilename;
                  localStorage.setItem('avatar', updatedAvatarFilename);
                  avatar = updatedAvatarFilename; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
              }

              if (Object.keys(updateData).length > 0) {
                    console.log("Updating profile on server:", { username: username, avatar: avatar });
                    socket.emit('user_active', { username: username, avatar: avatar }); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ—Å–ª–µ user_active
                    alert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    hideElement('profile-modal');
                    document.getElementById('new-username').value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                    document.getElementById('new-avatar').value = '';
                    document.getElementById('new-avatar-preview').style.display = 'none';
                    document.getElementById('new-avatar-preview').src = '#';

                    if (needsReload) {
                        console.log("Username changed, reloading page...");
                        location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    } else {
                         // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Ç–æ–ª—å–∫–æ –∞–≤–∞—Ç–∞—Ä, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                         updateMessageStyles();
                         updateUsersList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä
                    }
                } else {
                    hideElement('profile-modal'); // –ü—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
                }
          };

          // –ò–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          const saveProfileBtn = document.getElementById('save-profile-btn');


          if (newAvatarFile) {
               saveProfileBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
               saveProfileBtn.disabled = true;
              const formData = new FormData();
              formData.append('file', newAvatarFile);
              fetch('/upload', { method: 'POST', body: formData })
                  .then(response => {
                       if (!response.ok) throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
                       return response.text();
                   })
                  .then(filename => handleUpdate(filename))
                  .catch(error => {
                      console.error('Error updating profile avatar:', error);
                      alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞: ${error.message}.`);
                  })
                  .finally(() => {
                       saveProfileBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                       saveProfileBtn.disabled = false;
                  });
          } else {
              handleUpdate(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          }
      }


      // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ ---

      function replaceDenis(text) {
           return text.replace(/\b(–¥–µ–Ω–∏—Å|denis)\b/gi, '–•–£–ï–°–û–°');
      }

      function renderMessage(msg, prepend = false) {
          const chat = document.getElementById('chat');
          if (!chat) return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–∞–∫–∏–º ID —É–∂–µ –≤ —á–∞—Ç–µ
          if (document.querySelector(`.message[data-id="${msg.id}"]`)) {
              console.warn(`Message with ID ${msg.id} already exists. Skipping render.`);
              return;
          }

          const isScrolledToBottom = chat.scrollHeight - chat.clientHeight <= chat.scrollTop + 100; // –ë–æ–ª–µ–µ –º—è–≥–∫–æ–µ —É—Å–ª–æ–≤–∏–µ

          const div = document.createElement('div');
          div.className = 'message';
          div.dataset.id = msg.id;
          div.dataset.username = msg.username;

          // –ü–æ–ª—É—á–∞–µ–º –∞–≤–∞—Ç–∞—Ä –∏–∑ –∫—ç—à–∞ users –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
          const userAvatarFilename = users[msg.username]?.avatar || null;
          const avatarSrc = userAvatarFilename ? `/static/uploads/${userAvatarFilename}` : '/static/logo.png'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º logo.png –∫–∞–∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
          const defaultAvatarOnError = '/static/logo.png'; // –ü—É—Ç—å –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É –∞–≤–∞—Ç–∞—Ä—É –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏

          const messageText = replaceDenis(msg.text || ""); // –ó–∞–º–µ–Ω—è–µ–º –î–µ–Ω–∏—Å–∞

          let imageHTML = '';
          if (msg.image) {
              const imageSrc = `/static/uploads/${msg.image}`;
              // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ alt –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
              imageHTML = `<img src="${imageSrc}" class="content-img" onclick="openImageModal('${imageSrc}')" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç ${msg.username || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}">`;
          }

          let deleteButtonHTML = '';
          // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
          if (msg.username === username) {
              deleteButtonHTML = `<button class="delete-btn" onclick="deleteMessage('${msg.id}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>`;
          }

          div.innerHTML = `
              <img src="${avatarSrc}" class="avatar" alt="${msg.username}'s avatar" onerror="this.onerror=null;this.src='${defaultAvatarOnError}';">
              <div class="message-content-wrapper">
                   <span class="username">${msg.username || '–ê–Ω–æ–Ω–∏–º'}:</span>
                   <span class="message-text">${messageText}</span>
                   ${imageHTML}
              </div>
              ${deleteButtonHTML}
          `;

           if (prepend) {
               chat.insertBefore(div, chat.firstChild); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
           } else {
               chat.appendChild(div); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
           }

          updateSingleMessageStyle(div); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é

           // –ê–≤—Ç–æ-—Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –±—ã–ª–∏ –≤–Ω–∏–∑—É
           if (!prepend && isScrolledToBottom) {
              chat.scrollTop = chat.scrollHeight;
           }
      }

      function sendMessage() {
          const input = document.getElementById('message');
          const fileInput = document.getElementById('file-input');
          const text = input.value.trim();
          const file = fileInput.files[0];

          if ((text || file) && username) {
              const sendMessageData = (imageData = null) => {
                  console.log(`Sending message: Text='${text}', Image='${imageData}'`);
                  socket.emit('send_message', {
                      message: text,
                      username: username,
                      image: imageData
                  });
                  input.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                  fileInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —Ñ–∞–π–ª–∞
                  clearMessagePreview(); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é
              };

              if (file) {
                   // –ò–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                   const sendBtn = document.getElementById('send-btn');
                   sendBtn.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏

                  const formData = new FormData();
                  formData.append('file', file);
                  fetch('/upload', { method: 'POST', body: formData })
                      .then(response => {
                           if (!response.ok) throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
                           return response.text();
                       })
                      .then(filename => sendMessageData(filename))
                      .catch(error => {
                          console.error('Error uploading image:', error);
                          alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${error.message}.`);
                          clearMessagePreview(); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
                      })
                      .finally(() => {
                           sendBtn.disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                      });
              } else {
                  sendMessageData(); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
              }
          }
      }

       function deleteMessage(id) {
         if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            console.log(`Requesting deletion of message ID: ${id} by user: ${username}`);
            socket.emit('delete_message', { id: id, username: username });
         }
       }


      // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∏ –•–µ–ª–ø–µ—Ä—ã ---

      function updateMessageStyles() {
          const messages = document.querySelectorAll('.message');
          messages.forEach(msg => updateSingleMessageStyle(msg));
          // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏)
          const chat = document.getElementById('chat');
          if(chat) chat.scrollTop = chat.scrollHeight;
      }

      function updateSingleMessageStyle(msgElement) {
            if (!msgElement || !msgElement.dataset) return;
            const msgUsername = msgElement.dataset.username;
            const isMy = msgUsername === username;
            msgElement.classList.toggle('my-message', isMy);
            msgElement.classList.toggle('other-message', !isMy);

            const deleteBtn = msgElement.querySelector('.delete-btn');
            if(deleteBtn){
                deleteBtn.style.display = isMy ? '' : 'none'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
            }
             // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∞–≤–∞—Ç–∞—Ä–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å—Ç–∏–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
             const avatarImg = msgElement.querySelector('.avatar');
             if (avatarImg) {
                 const userAvatarFilename = users[msgUsername]?.avatar || null;
                 avatarImg.src = userAvatarFilename ? `/static/uploads/${userAvatarFilename}` : '/static/logo.png';
             }
      }

      function updateUsersList() {
          console.log("Updating users list display with data:", users);
          const usersContent = document.getElementById('users-content');
           if (!usersContent) return;
          usersContent.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫

          const now = new Date();
          const onlineThreshold = 60 * 1000; // 1 –º–∏–Ω—É—Ç–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–æ–Ω–ª–∞–π–Ω"

          let hasOtherUsers = false;
          Object.entries(users).forEach(([user, info]) => {
              if (user === username) return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–∫–µ
              hasOtherUsers = true;

              const div = document.createElement('div');
              div.className = 'user-item';
              div.id = `user-${user}`; // –î–æ–±–∞–≤–ª—è–µ–º ID –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

              const avatarFilename = info.avatar || null;
              const avatarSrc = avatarFilename ? `/static/uploads/${avatarFilename}` : '/static/logo.png';
              const defaultAvatarOnError = '/static/logo.png';

              let statusText = '–û—Ñ–ª–∞–π–Ω';
              let statusClass = 'offline';

              if (info.last_seen) {
                    try {
                       const lastSeenDate = new Date(info.last_seen);
                       const timeDiff = now.getTime() - lastSeenDate.getTime();

                       if (!isNaN(timeDiff) && timeDiff < onlineThreshold) {
                           statusText = '–û–Ω–ª–∞–π–Ω';
                           statusClass = 'online';
                       } else if (!isNaN(lastSeenDate.getTime())) {
                           // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É/–≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–∑–∏—Ç–∞
                           statusText = `–ë—ã–ª(–∞) ${lastSeenDate.toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' })}`;
                       } else {
                            statusText = "–°—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"; // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞
                       }
                    } catch (e) {
                        console.error("Error parsing date for user", user, info.last_seen, e);
                        statusText = "–°—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω";
                    }
              } else {
                    statusText = "–°—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"; // –ï—Å–ª–∏ –Ω–µ—Ç last_seen
              }

              // –ö–Ω–æ–ø–∫–∞ –∑–≤–æ–Ω–∫–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω
              const callButtonHTML = statusClass === 'online'
                  ? `<button class="call-user-btn" onclick="callUser('${user}')" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å ${user}">üìû</button>`
                  : '';

              div.innerHTML = `
                  <img src="${avatarSrc}" class="avatar ${statusClass}" alt="${user}'s avatar" onerror="this.onerror=null;this.src='${defaultAvatarOnError}';">
                  <div class="user-info">
                      <span class="username-in-list">${user}</span>
                      <span class="last-seen ${statusClass}">${statusText}</span>
                  </div>
                  ${callButtonHTML}
              `;

              usersContent.appendChild(div);
          });

           // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç
           if (!hasOtherUsers) {
                usersContent.innerHTML = '<p style="text-align: center; color: #7b1fa2; padding: 20px 0; font-style: italic;">–î—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç –æ–Ω–ª–∞–π–Ω</p>';
           }
      }

      function addEmoji(emoji) {
          const messageInput = document.getElementById('message');
          messageInput.value += emoji;
          hideElement('emoji-picker');
          messageInput.focus();
      }

      // –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π/—Å–º–µ–Ω–æ–π –∞–≤–∞—Ç–∞—Ä–∞
      function previewImage(event, previewElementId) {
          const previewElement = document.getElementById(previewElementId);
           if (!previewElement) return;
          const input = event.target;
          const file = input.files ? input.files[0] : null;

          if (file && file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = (e) => {
                  previewElement.src = e.target.result;
                  previewElement.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                   // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–≤—å—é —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ —ç—Ç–æ –æ–Ω)
                   if (previewElementId === 'message-preview') {
                        showElement('message-preview-container');
                   }
              }
              reader.readAsDataURL(file);
          } else {
               // –°–±—Ä–∞—Å—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω –∏–ª–∏ –Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞
              previewElement.src = '#';
              previewElement.style.display = 'none';
               if (previewElementId === 'message-preview') {
                    hideElement('message-preview-container');
               }
               // –û—á–∏—â–∞–µ–º input type="file", –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—ã–±–æ—Ä
               input.value = '';
          }
      }


       // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–≤—å—é —Å–æ–æ–±—â–µ–Ω–∏—è
       function clearMessagePreview() {
          const previewContainer = document.getElementById('message-preview-container');
          const previewImage = document.getElementById('message-preview');
          const fileInput = document.getElementById('file-input');
           if(previewImage) previewImage.src = '#';
           if(previewContainer) previewContainer.style.display = 'none';
           if(fileInput) fileInput.value = ''; // –í–∞–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ —Ñ–∞–π–ª–∞
       }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–µ–≤—å—é –¥–ª—è —Å–º–µ–Ω—ã –∞–≤–∞—Ç–∞—Ä–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
        document.getElementById('new-avatar').onchange = (event) => previewImage(event, 'new-avatar-preview');


      function requestNotificationPermission() {
         // ... (–∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ requestNotificationPermission –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ) ...
          if (!('Notification' in window)) {
            console.log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
            return;
          }
          if (Notification.permission === 'default') {
              Notification.requestPermission().then(permission => {
                  if (permission === 'granted') {
                      console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–æ');
                      new Notification('Huiber –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', {
                          body: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!',
                          icon: '/static/logo.png',
                          tag: 'huiber-permission' // –¢—ç–≥, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                      });
                  } else {
                      console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
                  }
              }).catch(err => {
                  console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:', err);
              });
          }
      }

       function showNotification(title, body, icon) {
           // ... (–∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ showNotification –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ) ...
            if ('Notification' in window && Notification.permission === 'granted' && document.hidden) {
                 // –ò—Å–ø–æ–ª—å–∑—É–µ–º tag, —á—Ç–æ–±—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–º–µ–Ω—è–ª–∏ –¥—Ä—É–≥ –¥—Ä—É–≥–∞, –∞ –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–ª–∏—Å—å
                 const notification = new Notification(title, { body: body, icon: icon || '/static/logo.png', tag: 'huiber-message' });
                  // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ
                  setTimeout(notification.close.bind(notification), 7000); // –ó–∞–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥
            }
       }

        // --- –§—É–Ω–∫—Ü–∏–∏ –ú–æ–¥–∞–ª—å–Ω–æ–≥–æ –û–∫–Ω–∞ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
       function openImageModal(src) {
           const modal = document.getElementById('imageModal');
           const modalImg = document.getElementById('modalImage');
            if (modal && modalImg) {
               modalImg.src = src;
               showElement('imageModal'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –¥–ª—è –ø–æ–∫–∞–∑–∞
            }
       }

       function closeImageModal(event) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –Ω–∞ —Ñ–æ–Ω–µ (–∞ –Ω–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ)
            // –∏–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ –∑–∞–∫—Ä—ã—Ç–∏—è
            if (!event || event.target.id === 'imageModal' || event.target.classList.contains('close-modal-btn')) {
               const modal = document.getElementById('imageModal');
               const modalImg = document.getElementById('modalImage');
                if (modal && modalImg) {
                   hideElement('imageModal');
                   modalImg.src = ''; // –û—á–∏—â–∞–µ–º src –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
                }
                 // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ –∫–Ω–æ–ø–∫–µ
                 if (event) event.stopPropagation();
            }
       }


      // --- –õ–æ–≥–∏–∫–∞ WebRTC –ó–≤–æ–Ω–∫–æ–≤ (—Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º) ---

      function createPeerConnection() {
          try {
               // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
               if (peerConnection) {
                   console.warn("Closing existing peer connection before creating a new one.");
                   cleanUpCall(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—á–∏—Å—Ç–∫–∏
               }

              console.log("[Peer] Creating PeerConnection with config:", configuration);
              peerConnection = new RTCPeerConnection(configuration);

              // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π PeerConnection ---

              // –ö–∞–Ω–¥–∏–¥–∞—Ç—ã ICE
              peerConnection.onicecandidate = event => {
                  if (event.candidate && currentTarget && username) { // –î–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞ username
                      console.log(`[Peer] Sending ICE candidate for ${currentTarget}:`, event.candidate.type, event.candidate.sdpMLineIndex);
                      socket.emit('ice_candidate', {
                          target: currentTarget,
                          candidate: event.candidate,
                          sender: username
                      });
                  } else if (!event.candidate) {
                      console.log("[Peer] All ICE candidates gathered.");
                  } else {
                       console.warn("[Peer] Not sending ICE candidate (no target/username or empty candidate).");
                  }
              };

              // –í—Ö–æ–¥—è—â–∏–π –º–µ–¥–∏–∞-—Ç—Ä–µ–∫
              peerConnection.ontrack = event => {
                  console.log("[Peer] Track received:", event.track.kind, "Stream:", event.streams[0]?.id);
                  const remoteAudio = document.getElementById('remote-audio');
                  if (remoteAudio && event.streams && event.streams[0]) {
                      console.log("[Peer] Attaching remote stream to audio element.");
                       // –í–∞–∂–Ω–æ: –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å srcObject –ø–æ–≤—Ç–æ—Ä–Ω–æ, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å
                       if (remoteAudio.srcObject !== event.streams[0]) {
                           remoteAudio.srcObject = event.streams[0];
                       } else {
                           console.log("[Peer] Remote stream already attached.");
                       }

                       // –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                       console.log("[Peer] Attempting to play remote audio...");
                       remoteAudio.play().then(() => {
                           console.log("[Peer] Remote audio playback started successfully.");
                           // –û–±–Ω–æ–≤–ª—è–µ–º UI —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                           document.getElementById('call-participants').textContent = `–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ —Å: ${currentTarget || '???'}`;
                           document.getElementById('connecting-indicator').style.display = 'none';
                       }).catch(e => {
                           console.error("[Peer] ERROR playing remote audio:", e);
                           document.getElementById('call-participants').textContent = `–†–∞–∑–≥–æ–≤–æ—Ä —Å ${currentTarget || '???'} (–ø—Ä–æ–±–ª–µ–º–∞ —Å–æ –∑–≤—É–∫–æ–º)`;
                           document.getElementById('connecting-indicator').style.display = 'none';
                           // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "Play" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                       });
                  } else {
                      console.error("[Peer] Failed to attach track: No remoteAudio element or stream available.");
                  }
              };

              // –°–æ—Å—Ç–æ—è–Ω–∏–µ ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
              peerConnection.oniceconnectionstatechange = () => {
                   if (!peerConnection) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
                   console.log(`[Peer] >> ICE Connection State Changed: ${peerConnection.iceConnectionState}`);
                   const indicator = document.getElementById('connecting-indicator');
                   const participantsText = document.getElementById('call-participants');
                   const targetName = currentTarget || "—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫";

                   switch(peerConnection.iceConnectionState) {
                       case "new":
                       case "checking":
                           if (indicator) indicator.style.display = 'block';
                           if (participantsText) participantsText.textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${targetName}...`;
                           break;
                       case "connected": // –ë–∞–∑–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å—Ç—å, –∂–¥–µ–º –º–µ–¥–∏–∞
                            if (indicator) indicator.style.display = 'none';
                            console.log("[Peer] ICE connected. Waiting for media stream via 'ontrack'.");
                            // –¢–µ–∫—Å—Ç –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ ontrack –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–µ–¥–∏–∞
                           break;
                       case "completed": // –û–±–º–µ–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏ –∑–∞–≤–µ—Ä—à–µ–Ω
                            if (indicator) indicator.style.display = 'none';
                            console.log("[Peer] ICE negotiation completed.");
                            break;
                       case "disconnected": // –ú–æ–∂–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
                            if (indicator) indicator.style.display = 'none';
                            if (participantsText) participantsText.textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${targetName} –ø—Ä–µ—Ä–≤–∞–Ω–æ...`;
                            console.warn("[Peer] ICE disconnected.");
                            break;
                       case "failed": // –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                            if (indicator) indicator.style.display = 'none';
                            if (participantsText) participantsText.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å ${targetName}`;
                            console.error("[Peer] ICE connection failed.");
                            alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${targetName}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.`);
                            endCall();
                            break;
                       case "closed": // –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ
                            if (indicator) indicator.style.display = 'none';
                            if (participantsText) participantsText.textContent = `–ó–≤–æ–Ω–æ–∫ —Å ${targetName} –∑–∞–≤–µ—Ä—à–µ–Ω`;
                            console.log("[Peer] ICE connection closed.");
                            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—à–ª–∞
                            cleanUpCall();
                            break;
                       default:
                            if (indicator) indicator.style.display = 'none';
                           break;
                   }
              };

               // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (offer/answer)
               peerConnection.onsignalingstatechange = () => {
                   if (!peerConnection) return;
                   console.log(`[Peer] >> Signaling State Changed: ${peerConnection.signalingState}`);
               };

              return peerConnection;

          } catch (error) {
              console.error("[Peer] FATAL Error creating PeerConnection:", error);
              alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –±—Ä–∞—É–∑–µ—Ä.");
              return null;
          }
      }

       async function startLocalMedia() {
           console.log("[Media] Requesting user media (audio only)...");
           try {
               localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
               console.log("[Media] Local media stream obtained successfully:", localStream.id);
               return localStream;
           } catch (error) {
               console.error("[Media] ERROR getting user media:", error.name, error.message);
               if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                   alert("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.");
               } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                   alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç.");
               } else {
                    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ${error.message}`);
               }
               return null;
           }
       }


      async function callUser(targetUsername) {
           console.log(`[CallFlow] Attempting callUser(${targetUsername}) by ${username}`);
          if (!username) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
          if (currentTarget) return alert("–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –∑–≤–æ–Ω–∫–µ –∏–ª–∏ –∑–≤–æ–Ω–∏—Ç–µ.");

          currentTarget = targetUsername;

          localStream = await startLocalMedia();
          if (!localStream) { currentTarget = null; return; } // –í—ã—Ö–æ–¥, –µ—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω

          peerConnection = createPeerConnection();
          if (!peerConnection) { cleanUpCall(); return; } // –í—ã—Ö–æ–¥, –µ—Å–ª–∏ PC –Ω–µ —Å–æ–∑–¥–∞–Ω

           // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
           console.log("[CallFlow:Caller] Adding local tracks...");
           localStream.getTracks().forEach(track => {
              try {
                  peerConnection.addTrack(track, localStream);
                  console.log(`[CallFlow:Caller] Local track added: ${track.kind} (${track.id})`);
              } catch (e) {
                  console.error("[CallFlow:Caller] ERROR adding track:", e);
              }
           });

           // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –∑–≤–æ–Ω–∫–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
           document.getElementById('call-participants').textContent = `–ó–≤–æ–Ω–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${currentTarget}...`;
           document.getElementById('connecting-indicator').style.display = 'block';
           showElement('call-window');

          try {
                console.log(`[CallFlow:Caller] Creating offer for ${currentTarget}`);
                const offer = await peerConnection.createOffer();
                console.log(`[CallFlow:Caller] Offer created. Setting local description.`);

                 // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
                 try {
                     await peerConnection.setLocalDescription(offer);
                     console.log(`[CallFlow:Caller] Local description (offer) set. Emitting offer to server.`);
                     // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ñ—Ñ–µ—Ä–∞ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
                     socket.emit('offer', {
                         offer: peerConnection.localDescription, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                         target: currentTarget,
                         caller: username
                     });
                 } catch (e) {
                      console.error(`[CallFlow:Caller] ERROR setting local description (offer):`, e);
                      alert(`–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è: ${e.message}`);
                      endCall();
                 }
          } catch (error) {
                console.error("[CallFlow:Caller] ERROR creating offer:", error);
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–≤–æ–Ω–∫–∞: ${error.message}`);
                endCall();
          }
      }

      async function acceptCall() {
          console.log(`[CallFlow:Callee] Attempting acceptCall() from ${currentTarget} by ${username}`);
          if (!currentTarget || !receivedOffer) {
              console.error("[CallFlow:Callee] Cannot accept call: Missing target or received offer.");
              rejectCall(); // –û—Ç–∫–ª–æ–Ω—è–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
              return;
          }

           hideElement('call-modal');
           ringtone.pause();
           ringtone.currentTime = 0;

          localStream = await startLocalMedia();
          if (!localStream) { rejectCall(); return; } // –û—Ç–∫–ª–æ–Ω—è–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

          peerConnection = createPeerConnection();
          if (!peerConnection) { rejectCall(); return; } // –û—Ç–∫–ª–æ–Ω—è–µ–º, –µ—Å–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è PC


           // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –∑–≤–æ–Ω–∫–∞ –¥–ª—è –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ
           document.getElementById('call-participants').textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${currentTarget}...`;
           document.getElementById('connecting-indicator').style.display = 'block';
           showElement('call-window');


           // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –ü–ï–†–ï–î —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π remote description
           console.log("[CallFlow:Callee] Adding local tracks...");
           localStream.getTracks().forEach(track => {
               try {
                   peerConnection.addTrack(track, localStream);
                   console.log(`[CallFlow:Callee] Local track added: ${track.kind} (${track.id})`);
               } catch (e) {
                   console.error("[CallFlow:Callee] ERROR adding track:", e);
               }
           });

          try {
              console.log(`[CallFlow:Callee] Setting remote description (offer) from ${currentTarget}`);
              await peerConnection.setRemoteDescription(new RTCSessionDescription(receivedOffer)); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ñ—Ñ–µ—Ä
              console.log(`[CallFlow:Callee] Remote description (offer) set. Creating answer.`);
              receivedOffer = null; // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ñ—Ñ–µ—Ä

              const answer = await peerConnection.createAnswer();
              console.log(`[CallFlow:Callee] Answer created. Setting local description (answer).`);

               // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è (–æ—Ç–≤–µ—Ç–∞)
               try {
                   await peerConnection.setLocalDescription(answer);
                   console.log(`[CallFlow:Callee] Local description (answer) set. Emitting answer to server for ${currentTarget}.`);
                   // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
                   socket.emit('answer', {
                       answer: peerConnection.localDescription, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                       target: currentTarget, // –ö–æ–º—É –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –æ—Ç–≤–µ—Ç (–∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É –∑–≤–æ–Ω–∫–∞)
                       caller: username      // –ö—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç (–º—ã)
                   });
               } catch(e) {
                   console.error(`[CallFlow:Callee] ERROR setting local description (answer):`, e);
                   alert(`–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è (–æ—Ç–≤–µ—Ç–∞): ${e.message}`);
                   endCall();
               }

          } catch (error) {
              console.error("[CallFlow:Callee] ERROR processing offer or creating answer:", error);
              alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–≤–æ–Ω–æ–∫: ${error.message}`);
              endCall();
          }
      }

      function rejectCall() {
          console.log(`[CallFlow] Rejecting call from ${currentTarget} by ${username}`);
          // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É–≤–µ–¥–æ–º–∏—Ç—å –∑–≤–æ–Ω—è—â–µ–≥–æ –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏
          // if (currentTarget) {
          //     socket.emit('call_rejected', { target: currentTarget, caller: username });
          // }
          cleanUpCall(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –æ—á–∏—Å—Ç–∫—É
          hideElement('call-modal'); // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–æ–¥–∞–ª–∫–∞ —Å–∫—Ä—ã—Ç–∞
      }

      function endCall() {
          console.log(`[CallFlow] Ending call with ${currentTarget} initiated by ${username}`);
          // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É–≤–µ–¥–æ–º–∏—Ç—å –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
          // if (currentTarget) {
          //     socket.emit('call_ended', { target: currentTarget, sender: username });
          // }
          cleanUpCall(); // –í—ã–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—á–∏—Å—Ç–∫–∏
      }


      function cleanUpCall() {
           console.log("[Cleanup] Starting call cleanup...");
           if (peerConnection) {
               peerConnection.onicecandidate = null;
               peerConnection.ontrack = null;
               peerConnection.oniceconnectionstatechange = null;
               peerConnection.onsignalingstatechange = null;
               // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –∑–∞–∫—Ä—ã—Ç–æ
               if (peerConnection.signalingState !== 'closed') {
                   peerConnection.close();
                   console.log("[Cleanup] PeerConnection closed.");
               }
               peerConnection = null; // –£–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫—É
           } else {
                console.log("[Cleanup] No active peer connection found.");
           }

           if (localStream) {
               console.log("[Cleanup] Stopping local stream tracks...");
               localStream.getTracks().forEach(track => track.stop());
               localStream = null;
           } else {
                console.log("[Cleanup] No active local stream found.");
           }

           const remoteAudio = document.getElementById('remote-audio');
            if (remoteAudio && remoteAudio.srcObject) {
               console.log("[Cleanup] Stopping remote stream tracks and clearing srcObject...");
               // remoteAudio.srcObject.getTracks().forEach(track => track.stop()); // –ë—Ä–∞—É–∑–µ—Ä –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å —ç—Ç–æ —Å–∞–º –ø—Ä–∏ srcObject = null
               remoteAudio.srcObject = null;
               remoteAudio.pause();
               remoteAudio.removeAttribute('src'); // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
               remoteAudio.load(); // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
            } else {
                 console.log("[Cleanup] No active remote stream found on audio element.");
            }

           // –°–±—Ä–æ—Å UI
           hideElement('call-window');
           hideElement('call-modal');
           const indicator = document.getElementById('connecting-indicator');
           const participantsText = document.getElementById('call-participants');
           if(indicator) indicator.style.display = 'none';
           if(participantsText) participantsText.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...';

           // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∏–Ω–≥—Ç–æ–Ω–∞
           ringtone.pause();
           ringtone.currentTime = 0;

           // –°–±—Ä–æ—Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–≤–æ–Ω–∫–∞
           console.log(`[Cleanup] Resetting call state (currentTarget was: ${currentTarget})`);
           currentTarget = null;
           receivedOffer = null;
           console.log("[Cleanup] Call cleanup finished.");
      }

      // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Socket.IO ---
      function setupGlobalListeners() {
          console.log("[Socket] Setting up global Socket.IO listeners.");

           // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
           socket.off('connect');
           socket.off('disconnect');
           socket.off('reconnect');
           socket.off('connect_error');
           socket.off('initial_messages');
           socket.off('new_message');
           socket.off('message_deleted');
           socket.off('users_list');
           socket.off('update_users');
           socket.off('incoming_call');
           socket.off('offer');
           socket.off('answer');
           socket.off('ice_candidate');
           // socket.off('call_ended_by_peer'); // –ï—Å–ª–∏ –±—É–¥–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å

            socket.on('connect', () => {
                console.log(`[Socket] Connected successfully with SID: ${socket.id}`);
                // –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ (–∏–ª–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏) —Å–Ω–æ–≤–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (username && avatar) {
                     console.log("[Socket] Re-emitting user_active and getting data on connect.");
                     socket.emit('user_active', { username: username, avatar: avatar });
                     socket.emit('get_users');
                     socket.emit('get_messages');
                }
            });

            socket.on('disconnect', (reason) => {
               console.warn(`[Socket] Disconnected: ${reason}`);
               // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ –ø—Ä–∏ –¥–∏—Å–∫–æ–Ω–Ω–µ–∫—Ç–µ
               if (currentTarget) {
                    console.warn("[Socket] Cleaning up call state due to disconnection.");
                    cleanUpCall();
                    alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω.");
               }
                // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ—Ç–µ—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            });

            socket.on('reconnect', (attemptNumber) => {
                console.log(`[Socket] Reconnected after ${attemptNumber} attempts.`);
                // User_active –∏ get_data –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º 'connect'
            });

            socket.on('connect_error', (err) => {
             console.error("[Socket] Connection error:", err.message);
             // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
              if (currentTarget) {
                  console.warn("[Socket] Cleaning up call state due to connection error.");
                  cleanUpCall();
              }
             alert("–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É —á–∞—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
           });


            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
           socket.on('initial_messages', function(loadedMessages) {
                console.log(`[Socket] Received initial_messages (${loadedMessages.messages?.length || 0} messages)`);
                const chat = document.getElementById('chat');
                if (!chat) return;
                chat.innerHTML = ''; // –û—á–∏—â–∞–µ–º —á–∞—Ç –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏

                if (loadedMessages.users) {
                     console.log("[Socket] Updating users cache from initial_messages");
                     users = loadedMessages.users; // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                }

                if (loadedMessages.messages && loadedMessages.messages.length > 0) {
                    loadedMessages.messages.forEach(msg => renderMessage(msg)); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                } else {
                     // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"
                     chat.innerHTML = '<p style="text-align: center; color: #7b1fa2; padding: 50px 0; font-style: italic;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...</p>';
                }
                updateMessageStyles(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∏ —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑
            });

          socket.on('new_message', function(msg) {
             console.log(`[Socket] Received new_message from ${msg.username} (ID: ${msg.id})`);
             // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –∏–Ω—Ñ–æ –ø—Ä–∏—à–ª–æ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
              if (msg.username && msg.avatar && (!users[msg.username] || users[msg.username].avatar !== msg.avatar)) {
                  console.log(`[Socket] Updating user cache for ${msg.username} from new_message`);
                  users[msg.username] = { ...(users[msg.username] || {}), avatar: msg.avatar, last_seen: new Date().toISOString() };
              }
             renderMessage(msg); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü —á–∞—Ç–∞
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
             if (msg.username !== username) {
                 const avatarSrc = users[msg.username]?.avatar ? `/static/uploads/${users[msg.username].avatar}` : '/static/logo.png';
                 showNotification(
                     `–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${msg.username}`,
                     replaceDenis(msg.text || (msg.image ? "[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]" : "")),
                     avatarSrc
                 );
             }
          });

          socket.on('message_deleted', function(data) {
             console.log(`[Socket] Received message_deleted for ID: ${data.id}`);
             const msgElement = document.querySelector(`.message[data-id="${data.id}"]`);
             if (msgElement) {
                 msgElement.remove();
                 console.log(`[UI] Message element ${data.id} removed.`);
             } else {
                  console.warn(`[UI] Could not find message element ${data.id} to delete.`);
             }
          });

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–æ–ª–Ω–æ–µ –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ)
          socket.on('users_list', function(users_data) {
             console.log("[Socket] Received users_list update.");
             users = users_data || {}; // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
             updateUsersList();
             updateMessageStyles(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–∞ —Å–ª—É—á–∞–π —Å–º–µ–Ω—ã –∞–≤–∞—Ç–∞—Ä–∞)
          });
           // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —à–ª–µ—Ç 'update_users'
           socket.on('update_users', function(users_data) {
               console.log("[Socket] Received 'update_users' (legacy?) update.");
               users = users_data || {};
               updateUsersList();
               updateMessageStyles();
           });


          // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ WebRTC ---

          socket.on('incoming_call', function(data) {
             console.log(`[Socket] Received incoming_call from: ${data.caller}`);
             if (currentTarget) {
                 console.warn(`[Socket] Ignoring incoming call from ${data.caller} because already in call with ${currentTarget}.`);
                 // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –£–≤–µ–¥–æ–º–∏—Ç—å –∑–≤–æ–Ω—è—â–µ–≥–æ, —á—Ç–æ –≤—ã –∑–∞–Ω—è—Ç—ã
                 // socket.emit('user_busy', { target: data.caller, caller: username });
                 return;
             }
              // –ñ–¥–µ–º 'offer' —Å–æ–±—ã—Ç–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ
              currentTarget = data.caller;
              document.getElementById('call-text').textContent = `–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${currentTarget}`;
              showElement('call-modal');
              ringtone.play().catch(e => console.warn("Ringtone play failed:", e));
          });


          socket.on('offer', async function(data) {
               console.log(`[Socket:${username}] Received 'offer' event from ${data.sender}`);
               // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º—ã–π –∑–≤–æ–Ω—è—â–∏–π –∏ –º—ã –Ω–µ –≤ –∑–≤–æ–Ω–∫–µ/–Ω–µ –∑–≤–æ–Ω–∏–º —Å–∞–º–∏
               // (currentTarget —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ incoming_call)
               if (data.sender === currentTarget) {
                   if (peerConnection && peerConnection.signalingState !== 'stable') {
                        console.warn(`[Socket:${username}] Received offer while P.C. is not stable (${peerConnection.signalingState}). Ignoring.`);
                        return; // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –æ—Ñ—Ñ–µ—Ä, –µ—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                   }
                   console.log(`[Socket:${username}] Storing received offer from ${data.sender}.`);
                   receivedOffer = data.offer; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è acceptCall
                   // –ù–µ —Å–æ–∑–¥–∞–µ–º PeerConnection –∑–¥–µ—Å—å, –∂–¥–µ–º –Ω–∞–∂–∞—Ç–∏—è Accept
               } else {
                    console.warn(`[Socket:${username}] Ignoring offer from unexpected sender: ${data.sender}. Expecting: ${currentTarget}`);
               }
          });


          socket.on('answer', async function(data) {
               console.log(`[Socket:${username}] Received 'answer' event from ${data.sender}`);
               // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
               if (peerConnection && data.sender === currentTarget) {
                   if (peerConnection.signalingState === 'have-local-offer') {
                       console.log(`[Socket:${username}] Setting remote description (answer) from ${currentTarget}`);
                       try {
                           await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                           console.log(`[Socket:${username}] Remote description (answer) set successfully.`);
                       } catch (error) {
                           console.error(`[Socket:${username}] ERROR setting remote description (answer):`, error);
                           alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç ${currentTarget}: ${error.message}`);
                           endCall();
                       }
                   } else {
                        console.warn(`[Socket:${username}] Received answer in unexpected signaling state: ${peerConnection.signalingState}. Ignoring.`);
                   }
               } else {
                   console.warn(`[Socket:${username}] Ignoring answer: PC?(${!!peerConnection}) Sender?(${data.sender} vs ${currentTarget})`);
               }
          });


          socket.on('ice_candidate', async function(data) {
               // console.log(`[Socket:${username}] Received 'ice_candidate' event from ${data.sender}`); // –û—á–µ–Ω—å –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤, –º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
               // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –æ–Ω–æ –Ω–µ –∑–∞–∫—Ä—ã—Ç–æ, –∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –ø–∏—Ä–∞
               if (peerConnection && peerConnection.signalingState !== 'closed' && data.sender === currentTarget && data.candidate) {
                    try {
                       // console.log(`[Socket:${username}] Adding received ICE candidate from ${currentTarget}`); // –¢–æ–∂–µ –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤
                       await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                       // console.log(`[Socket:${username}] ICE candidate added successfully.`);
                   } catch (error) {
                       // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –µ—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è/–∑–∞–∫—Ä—ã—Ç–æ
                       if (peerConnection && peerConnection.signalingState !== 'closed') {
                          console.warn(`[Socket:${username}] Error adding received ICE candidate:`, error.message);
                       }
                   }
               } else {
                   // –õ–æ–≥–∏—Ä—É–µ–º –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∞—è —Ü–µ–ª—å –∑–≤–æ–Ω–∫–∞
                   // if (currentTarget) {
                   //     console.warn(`[Socket:${username}] Ignoring ICE candidate: PC?(${!!peerConnection}) Closed?(${peerConnection?.signalingState === 'closed'}) Sender?(${data.sender} vs ${currentTarget}) Cand?(${!!data.candidate})`);
                   // }
               }
          });

          // --- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞ –¥—Ä—É–≥–∏–º –ø–∏—Ä–æ–º ---
          // –í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ emit –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –∑–¥–µ—Å—å
          // socket.on('call_ended_by_peer', function(data) {
          //     if (data.sender === currentTarget) {
          //         console.log(`[Socket] Call ended by peer: ${data.sender}`);
          //         alert(`–ó–≤–æ–Ω–æ–∫ —Å ${data.sender} –∑–∞–≤–µ—Ä—à–µ–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.`);
          //         cleanUpCall();
          //     }
          // });
          // socket.on('call_rejected_by_peer', function(data) {
          //     if (data.sender === currentTarget) {
          //         console.log(`[Socket] Call rejected by peer: ${data.sender}`);
          //         alert(`${data.sender} –æ—Ç–∫–ª–æ–Ω–∏–ª(–∞) –≤–∞—à –∑–≤–æ–Ω–æ–∫.`);
          //         cleanUpCall();
          //     }
          // });
          // socket.on('peer_is_busy', function(data) {
          //     if (data.sender === currentTarget) {
          //         console.log(`[Socket] Peer is busy: ${data.sender}`);
          //         alert(`${data.sender} —Å–µ–π—á–∞—Å –∑–∞–Ω—è—Ç(–∞).`);
          //         cleanUpCall();
          //     }
          // });

      } // --- –ö–æ–Ω–µ—Ü setupGlobalListeners ---


      // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π UI ---
      document.getElementById('message').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
      });

      document.getElementById('profile-btn').addEventListener('click', function() {
         document.getElementById('new-username').value = username || ''; // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è
         const currentAvatarPreview = document.getElementById('new-avatar-preview');
         if (avatar) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä
            currentAvatarPreview.src = `/static/uploads/${avatar}`;
            currentAvatarPreview.style.display = 'block';
         } else {
            currentAvatarPreview.style.display = 'none';
            currentAvatarPreview.src = '#';
         }
         showElement('profile-modal');
      });

      document.getElementById('emoji-btn').addEventListener('click', function(event) {
         event.stopPropagation();
         const picker = document.getElementById('emoji-picker');
         picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∏–∫–µ—Ä–∞ —ç–º–æ–¥–∑–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
      document.addEventListener('click', function(event) {
         const picker = document.getElementById('emoji-picker');
         const emojiBtn = document.getElementById('emoji-btn');
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∏–∫–µ—Ä –≤–∏–¥–∏–º, –∏ –∫–ª–∏–∫ –±—ã–ª –Ω–µ –ø–æ –Ω–µ–º—É –∏ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ –µ–≥–æ –≤—ã–∑–æ–≤–∞
         if (picker && picker.style.display === 'block' && !picker.contains(event.target) && event.target !== emojiBtn) {
           hideElement('emoji-picker');
         }
       });

       // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ —á–∞—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ---
       window.onload = () => {
         const chat = document.getElementById('chat');
         if(chat) chat.scrollTop = chat.scrollHeight;
       };
    </script>
  </body>
</html>
