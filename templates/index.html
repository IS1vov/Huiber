<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Huiber</title>
    <style>
      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin: 0;
          background-color: #fafafa;
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      h1 {
          font-size: 24px;
          color: #262626;
          margin: 20px 0;
          display: flex;
          align-items: center;
      }
      #chat-container, #username-form {
          width: 100%;
          max-width: 600px;
          background: white;
          border: 1px solid #dbdbdb;
          border-radius: 10px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      #chat {
          height: 500px;
          overflow-y: auto;
          padding: 20px;
      }
      .message {
          margin: 10px 0;
          padding: 12px 16px;
          border-radius: 20px;
          max-width: 70%;
          word-wrap: break-word;
          position: relative;
      }
      .my-message {
          background-color: #0095f6;
          color: white;
          margin-left: auto;
      }
      .other-message {
          background-color: #e9ecef;
          color: #262626;
          margin-right: auto;
      }
      .username {
          font-weight: 600;
          margin-right: 5px;
      }
      .message img {
          max-width: 100%;
          border-radius: 10px;
          margin-top: 5px;
      }
      #input-area {
          display: flex;
          padding: 20px;
          border-top: 1px solid #dbdbdb;
          align-items: center;
      }
      #message {
          flex: 1;
          padding: 10px;
          border: 1px solid #dbdbdb;
          border-radius: 20px;
          outline: none;
          font-size: 14px;
      }
      #send-btn, #emoji-btn, #file-btn {
          background: none;
          border: none;
          color: #0095f6;
          font-weight: 600;
          margin-left: 10px;
          cursor: pointer;
      }
      #username-form {
          padding: 20px;
          text-align: center;
      }
      #username, #avatar {
          padding: 10px;
          border: 1px solid #dbdbdb;
          border-radius: 5px;
          width: 70%;
          margin-bottom: 10px;
      }
      #save-btn {
          background-color: #0095f6;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 5px;
          cursor: pointer;
      }
      .avatar {
          width: 30px;
          height: 30px;
          border-radius: 50%;
          margin-right: 10px;
          vertical-align: middle;
      }
      #emoji-picker {
          display: none;
          position: absolute;
          bottom: 70px;
          background: white;
          border: 1px solid #dbdbdb;
          padding: 10px;
          border-radius: 10px;
      }
      .emoji {
          font-size: 20px;
          cursor: pointer;
          margin: 5px;
      }
      .delete-btn {
          background: none;
          border: none;
          color: #ed4956;
          font-weight: 600;
          margin-left: 10px;
          cursor: pointer;
          display: none;
      }
      .admin-mode .delete-btn {
          display: inline;
      }
    </style>
  </head>
  <body>
    <h1>
      Huiber
      <button
        id="admin-btn"
        style="font-size: 14px; margin-left: 10px; background: none; border: none; color: #0095f6; cursor: pointer;"
      >
        –ê–¥–º–∏–Ω
      </button>
    </h1>
    <div id="username-form" style="display: none;">
      <input type="text" id="username" placeholder="–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è" />
      <br />
      <input type="file" id="avatar" accept="image/*" />
      <br />
      <button id="save-btn" onclick="setUsername()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div id="chat-container" style="display: none;">
      <div id="chat">
        {% for msg in messages %}
        <div
          class="message"
          data-id="{{ msg.id }}"
          data-username="{{ msg.username }}"
        >
          {% if msg.username in avatars %}
          <img
            src="/static/uploads/{{ avatars[msg.username] }}"
            class="avatar"
          />
          {% endif %}
          <span class="username">{{ msg.username }}</span> {{ msg.text }} {% if
          msg.image %}
          <img src="/static/uploads/{{ msg.image }}" />
          {% endif %}
          <button class="delete-btn" onclick="deleteMessage('{{ msg.id }}')">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
        {% endfor %}
      </div>
      <div id="input-area">
        <input type="text" id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="emoji-btn">üòä</button>
        <input
          type="file"
          id="file-input"
          accept="image/*"
          style="display: none;"
        />
        <button
          id="file-btn"
          onclick="document.getElementById('file-input').click()"
        >
          üì∑
        </button>
        <button id="send-btn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div id="emoji-picker">
        <span class="emoji" onclick="addEmoji('üòä')">üòä</span>
        <span class="emoji" onclick="addEmoji('üòÇ')">üòÇ</span>
        <span class="emoji" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="emoji" onclick="addEmoji('üëç')">üëç</span>
        <span class="emoji" onclick="addEmoji('üò¢')">üò¢</span>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script>
      const socket = io();
      let username = localStorage.getItem('username');
      let avatar = localStorage.getItem('avatar');
      let isAdmin = false;

      if (!username) {
          document.getElementById('username-form').style.display = 'block';
      } else {
          document.getElementById('chat-container').style.display = 'block';
          updateMessageStyles();
      }

      function setUsername() {
          username = document.getElementById('username').value.trim();
          const avatarInput = document.getElementById('avatar');
          if (username && avatarInput.files[0]) {
              const formData = new FormData();
              formData.append('file', avatarInput.files[0]);
              fetch('/upload', { method: 'POST', body: formData })
                  .then(response => response.text())
                  .then(filename => {
                      avatar = filename;
                      localStorage.setItem('username', username);
                      localStorage.setItem('avatar', avatar);
                      document.getElementById('username-form').style.display = 'none';
                      document.getElementById('chat-container').style.display = 'block';
                      updateMessageStyles();
                  });
          }
      }

      socket.on('new_message', function(msg) {
          const chat = document.getElementById('chat');
          const div = document.createElement('div');
          div.className = 'message';
          div.dataset.id = msg.id;
          div.dataset.username = msg.username;
          div.innerHTML = `${msg.username in localStorage ? '<img src="/static/uploads/' + localStorage.getItem('avatar') + '" class="avatar">' : ''}<span class="username">${msg.username}</span> ${msg.text}${msg.image ? '<img src="/static/uploads/' + msg.image + '">' : ''}<button class="delete-btn" onclick="deleteMessage('${msg.id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
          chat.appendChild(div);
          updateMessageStyles();
          chat.scrollTop = chat.scrollHeight;
      });

      socket.on('message_deleted', function(data) {
          const msgElement = document.querySelector(`.message[data-id="${data.id}"]`);
          if (msgElement) msgElement.remove();
      });

      function sendMessage() {
          const input = document.getElementById('message');
          const fileInput = document.getElementById('file-input');
          const text = input.value.trim();
          if ((text || fileInput.files[0]) && username) {
              if (fileInput.files[0]) {
                  const formData = new FormData();
                  formData.append('file', fileInput.files[0]);
                  fetch('/upload', { method: 'POST', body: formData })
                      .then(response => response.text())
                      .then(filename => {
                          socket.emit('send_message', { message: text, username: username, image: filename });
                          input.value = '';
                          fileInput.value = '';
                      });
              } else {
                  socket.emit('send_message', { message: text, username: username });
                  input.value = '';
              }
          }
      }

      function deleteMessage(id) {
          if (isAdmin) {
              socket.emit('delete_message', { id: id, is_admin: true, password: 'nadya' });
          }
      }

      function updateMessageStyles() {
          const messages = document.querySelectorAll('.message');
          messages.forEach(msg => {
              const msgUsername = msg.dataset.username;
              msg.classList.toggle('my-message', msgUsername === username);
              msg.classList.toggle('other-message', msgUsername !== username);
              if (isAdmin) msg.classList.add('admin-mode');
          });
      }

      document.getElementById('message').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') sendMessage();
      });

      document.getElementById('admin-btn').addEventListener('click', function() {
          const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∞–¥–º–∏–Ω–∞:');
          if (password === 'nadya') {
              isAdmin = true;
              updateMessageStyles();
              alert('–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω!');
          } else {
              alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
          }
      });

      document.getElementById('emoji-btn').addEventListener('click', function() {
          const picker = document.getElementById('emoji-picker');
          picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
      });

      function addEmoji(emoji) {
          document.getElementById('message').value += emoji;
          document.getElementById('emoji-picker').style.display = 'none';
      }
    </script>
  </body>
</html>
