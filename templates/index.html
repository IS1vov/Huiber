<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Huiber</title>
    <style>
      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin: 0;
          background-color: #f3e5f5;
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      h1 {
          font-size: 24px;
          color: #4a148c;
          margin: 20px 0;
          display: flex;
          align-items: center;
      }
      #chat-container, #username-form, #profile-modal, #users-list {
          width: 100%;
          max-width: 600px;
          background: rgba(255, 255, 255, 0.9);
          border: 1px solid #ce93d8;
          border-radius: 15px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      #chat {
          height: 500px;
          overflow-y: auto;
          padding: 20px;
          background: url('/static/background.png') no-repeat center center;
          background-size: cover;
      }
      .message {
          margin: 10px 0;
          padding: 12px 16px;
          border-radius: 20px;
          max-width: 70%;
          word-wrap: break-word;
          display: flex;
          align-items: center;
      }
      .my-message {
          background-color: #ab47bc;
          color: white;
          margin-left: auto;
      }
      .other-message {
          background-color: #f06292;
          color: white;
          margin-right: auto;
      }
      .username {
          font-weight: 600;
          margin-left: 5px;
      }
      .message img.content-img {
          max-width: 100%;
          border-radius: 10px;
          margin-top: 5px;
      }
      .avatar {
          width: 24px;
          height: 24px;
          border-radius: 50%;
          margin-right: 5px;
      }
      #input-area {
          display: flex;
          padding: 20px;
          border-top: 1px solid #ce93d8;
          align-items: center;
          background: rgba(255, 255, 255, 0.9);
      }
      #message {
          flex: 1;
          padding: 10px;
          border: 1px solid #ce93d8;
          border-radius: 20px;
          outline: none;
          font-size: 14px;
          background: #fff;
      }
      #send-btn, #emoji-btn, #file-btn, #profile-btn {
          background: none;
          border: none;
          color: #7b1fa2;
          font-weight: 600;
          margin-left: 10px;
          cursor: pointer;
      }
      #username-form, #profile-modal {
          padding: 20px;
          text-align: center;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          display: none;
          z-index: 10;
      }
      #username, #avatar, #new-username, #new-avatar {
          padding: 10px;
          border: 1px solid #ce93d8;
          border-radius: 5px;
          width: 70%;
          margin-bottom: 10px;
      }
      #save-btn, #save-profile-btn {
          background-color: #ab47bc;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 5px;
          cursor: pointer;
      }
      #emoji-picker {
          display: none;
          position: absolute;
          bottom: 70px;
          background: white;
          border: 1px solid #ce93d8;
          padding: 10px;
          border-radius: 10px;
      }
      .emoji {
          font-size: 20px;
          cursor: pointer;
          margin: 5px;
      }
      .delete-btn {
          background: none;
          border: none;
          color: #d81b60;
          font-weight: 600;
          margin-left: 10px;
          cursor: pointer;
          display: none;
      }
      .admin-mode .delete-btn {
          display: inline;
      }
      #users-list {
          padding: 20px;
          margin-top: 20px;
      }
      .user-item {
          display: flex;
          align-items: center;
          margin: 10px 0;
      }
      .user-item img {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Huiber <button id="profile-btn">–ü—Ä–æ—Ñ–∏–ª—å</button></h1>
    <div id="username-form" style="display: none;">
      <input type="text" id="username" placeholder="–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è" />
      <br />
      <input type="file" id="avatar" accept="image/*" />
      <br />
      <button id="save-btn" onclick="setUsername()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div id="profile-modal" style="display: none;">
      <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
      <input type="text" id="new-username" placeholder="–ù–æ–≤–æ–µ –∏–º—è" />
      <br />
      <input type="file" id="new-avatar" accept="image/*" />
      <br />
      <button id="save-profile-btn" onclick="updateProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <br />
      <button
        id="admin-btn"
        style="margin-top: 10px; background: none; border: none; color: #7b1fa2; cursor: pointer;"
      >
        –í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω
      </button>
    </div>
    <div id="chat-container" style="display: none;">
      <div id="chat">
        {% for msg in messages %}
        <div
          class="message"
          data-id="{{ msg.id }}"
          data-username="{{ msg.username }}"
        >
          {% if msg.username in users %}
          <img
            src="/static/uploads/{{ users[msg.username].avatar }}"
            class="avatar"
          />
          {% endif %}
          <span class="username">{{ msg.username }}:</span> {{ msg.text }} {% if
          msg.image %}
          <img src="/static/uploads/{{ msg.image }}" class="content-img" />
          {% endif %}
          <button class="delete-btn" onclick="deleteMessage('{{ msg.id }}')">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
        {% endfor %}
      </div>
      <div id="input-area">
        <input type="text" id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="emoji-btn">üòä</button>
        <input
          type="file"
          id="file-input"
          accept="image/*"
          style="display: none;"
        />
        <button
          id="file-btn"
          onclick="document.getElementById('file-input').click()"
        >
          üì∑
        </button>
        <button id="send-btn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div id="emoji-picker">
        <span class="emoji" onclick="addEmoji('üòä')">üòä</span>
        <span class="emoji" onclick="addEmoji('üòÇ')">üòÇ</span>
        <span class="emoji" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="emoji" onclick="addEmoji('üëç')">üëç</span>
        <span class="emoji" onclick="addEmoji('üò¢')">üò¢</span>
      </div>
    </div>
    <div id="users-list">
      <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
      <div id="users-content"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script>
      const socket = io();
      let username = localStorage.getItem('username');
      let avatar = localStorage.getItem('avatar');
      let isAdmin = false;
      let users = {};

      if (!username) {
          document.getElementById('username-form').style.display = 'block';
      } else {
          document.getElementById('chat-container').style.display = 'block';
          updateMessageStyles();
          socket.emit('user_active', { username: username, avatar: avatar });
      }

      function setUsername() {
          username = document.getElementById('username').value.trim();
          const avatarInput = document.getElementById('avatar');
          if (username && avatarInput.files[0]) {
              const formData = new FormData();
              formData.append('file', avatarInput.files[0]);
              fetch('/upload', { method: 'POST', body: formData })
                  .then(response => response.text())
                  .then(filename => {
                      avatar = filename;
                      localStorage.setItem('username', username);
                      localStorage.setItem('avatar', avatar);
                      document.getElementById('username-form').style.display = 'none';
                      document.getElementById('chat-container').style.display = 'block';
                      updateMessageStyles();
                      socket.emit('user_active', { username: username, avatar: avatar });
                  });
          }
      }

      function updateProfile() {
          const newUsername = document.getElementById('new-username').value.trim();
          const newAvatarInput = document.getElementById('new-avatar');
          if (newUsername || newAvatarInput.files[0]) {
              if (newAvatarInput.files[0]) {
                  const formData = new FormData();
                  formData.append('file', newAvatarInput.files[0]);
                  fetch('/upload', { method: 'POST', body: formData })
                      .then(response => response.text())
                      .then(filename => {
                          username = newUsername || username;
                          avatar = filename;
                          localStorage.setItem('username', username);
                          localStorage.setItem('avatar', avatar);
                          document.getElementById('profile-modal').style.display = 'none';
                          updateMessageStyles();
                          socket.emit('user_active', { username: username, avatar: avatar });
                          location.reload();
                      });
              } else {
                  username = newUsername || username;
                  localStorage.setItem('username', username);
                  document.getElementById('profile-modal').style.display = 'none';
                  updateMessageStyles();
                  socket.emit('user_active', { username: username, avatar: avatar });
                  location.reload();
              }
          }
      }

      socket.on('new_message', function(msg) {
          const chat = document.getElementById('chat');
          const div = document.createElement('div');
          div.className = 'message';
          div.dataset.id = msg.id;
          div.dataset.username = msg.username;
          const avatarSrc = (msg.username === username && avatar) ? `/static/uploads/${avatar}` : (users[msg.username] ? `/static/uploads/${users[msg.username].avatar}` : '');
          div.innerHTML = `${avatarSrc ? '<img src="' + avatarSrc + '" class="avatar">' : ''}<span class="username">${msg.username}:</span> ${msg.text}${msg.image ? '<img src="/static/uploads/' + msg.image + '" class="content-img">' : ''}<button class="delete-btn" onclick="deleteMessage('${msg.id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
          chat.appendChild(div);
          updateMessageStyles();
          chat.scrollTop = chat.scrollHeight;
      });

      socket.on('message_deleted', function(data) {
          const msgElement = document.querySelector(`.message[data-id="${data.id}"]`);
          if (msgElement) msgElement.remove();
      });

      socket.on('users_list', function(users_data) {
          users = users_data;
          updateUsersList();
      });

      socket.on('update_users', function(users_data) {
          users = users_data;
          if (isAdmin) {
              socket.emit('get_users', { is_admin: true, password: 'nadya' });
          }
          updateMessageStyles();
          updateUsersList();
      });

      function updateUsersList() {
          const usersContent = document.getElementById('users-content');
          if (isAdmin) {
              usersContent.innerHTML = '';
              for (const [username, info] of Object.entries(users)) {
                  const lastSeen = new Date(info.last_seen).toLocaleString();
                  const div = document.createElement('div');
                  div.className = 'user-item';
                  div.innerHTML = `<img src="/static/uploads/${info.avatar}" class="avatar"><span>${username} ‚Äî –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –æ–Ω–ª–∞–π–Ω: ${lastSeen}</span>`;
                  usersContent.appendChild(div);
              }
          } else {
              usersContent.innerHTML = '<p>–í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –∞–¥–º–∏–Ω, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</p>';
          }
      }

      function sendMessage() {
          const input = document.getElementById('message');
          const fileInput = document.getElementById('file-input');
          const text = input.value.trim();
          if ((text || fileInput.files[0]) && username) {
              if (fileInput.files[0]) {
                  const formData = new FormData();
                  formData.append('file', fileInput.files[0]);
                  fetch('/upload', { method: 'POST', body: formData })
                      .then(response => response.text())
                      .then(filename => {
                          socket.emit('send_message', { message: text, username: username, image: filename });
                          input.value = '';
                          fileInput.value = '';
                          socket.emit('user_active', { username: username, avatar: avatar });
                      });
              } else {
                  socket.emit('send_message', { message: text, username: username });
                  input.value = '';
                  socket.emit('user_active', { username: username, avatar: avatar });
              }
          }
      }

      function deleteMessage(id) {
          if (isAdmin) {
              socket.emit('delete_message', { id: id, is_admin: true, password: 'nadya' });
          }
      }

      function updateMessageStyles() {
          const messages = document.querySelectorAll('.message');
          messages.forEach(msg => {
              const msgUsername = msg.dataset.username;
              msg.classList.toggle('my-message', msgUsername === username);
              msg.classList.toggle('other-message', msgUsername !== username);
              if (isAdmin) msg.classList.add('admin-mode');
          });
      }

      document.getElementById('message').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') sendMessage();
      });

      document.getElementById('profile-btn').addEventListener('click', function() {
          document.getElementById('profile-modal').style.display = 'block';
          document.getElementById('new-username').value = username;
      });

      document.getElementById('admin-btn').addEventListener('click', function() {
          const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∞–¥–º–∏–Ω–∞:');
          if (password === 'nadya') {
              isAdmin = true;
              updateMessageStyles();
              socket.emit('get_users', { is_admin: true, password: 'nadya' });
              alert('–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω!');
              updateUsersList();
          } else {
              alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
          }
      });

      document.getElementById('emoji-btn').addEventListener('click', function() {
          const picker = document.getElementById('emoji-picker');
          picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
      });

      function addEmoji(emoji) {
          document.getElementById('message').value += emoji;
          document.getElementById('emoji-picker').style.display = 'none';
      }

      setInterval(() => {
          if (username) {
              socket.emit('user_active', { username: username, avatar: avatar });
          }
      }, 10000);
    </script>
  </body>
</html>
