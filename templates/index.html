<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Huiber</title>
    <link rel="icon" type="image/png" href="/static/logo.png" />
    <style>
      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin: 0;
          background: url('/static/background.png') no-repeat center center fixed;
          background-size: cover;
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      h1 {
          font-size: 24px;
          color: #4a148c;
          margin: 20px 0;
          display: flex;
          align-items: center;
      }
      #chat-container, #username-form, #profile-modal, #users-list, #call-modal, #call-window {
          width: 100%;
          max-width: 600px;
          background: rgba(255, 255, 255, 0.9);
          border: 1px solid #ce93d8;
          border-radius: 15px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      #chat {
          height: 500px;
          overflow-y: auto;
          padding: 20px;
          background: #f3e5f5;
      }
      .message {
          margin: 10px 0;
          padding: 12px 16px;
          border-radius: 20px;
          max-width: 70%;
          word-wrap: break-word;
          display: flex;
          align-items: center;
      }
      .my-message {
          background-color: #ab47bc;
          color: white;
          margin-left: auto;
      }
      .other-message {
          background-color: #f06292;
          color: white;
          margin-right: auto;
      }
      .username {
          font-weight: 600;
          margin-left: 5px;
      }
      .message img.content-img {
          max-width: 100%;
          border-radius: 10px;
          margin-top: 5px;
      }
      .avatar {
          width: 24px;
          height: 24px;
          border-radius: 50%;
          margin-right: 5px;
      }
      #input-area {
          display: flex;
          padding: 20px;
          border-top: 1px solid #ce93d8;
          align-items: center;
          background: rgba(255, 255, 255, 0.9);
      }
      #message {
          flex: 1;
          padding: 10px;
          border: 1px solid #ce93d8;
          border-radius: 20px;
          outline: none;
          font-size: 14px;
          background: #fff;
      }
      #send-btn, #emoji-btn, #file-btn, #profile-btn, .call-user-btn {
          background: none;
          border: none;
          color: #7b1fa2;
          font-weight: 600;
          margin-left: 10px;
          cursor: pointer;
      }
      .call-user-btn {
          background-color: #8b4513;
          color: white;
          padding: 5px 10px;
          border-radius: 5px;
      }
      .call-user-btn:hover {
          background-color: #a0522d;
      }
      #username-form, #profile-modal, #call-modal, #call-window {
          padding: 20px;
          text-align: center;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          display: none;
          z-index: 10;
      }
      #username, #avatar, #new-username, #new-avatar {
          padding: 10px;
          border: 1px solid #ce93d8;
          border-radius: 5px;
          width: 70%;
          margin-bottom: 10px;
      }
      #save-btn, #save-profile-btn, #accept-call-btn, #reject-call-btn, #end-call-btn {
          background-color: #ab47bc;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 5px;
          cursor: pointer;
          margin: 5px;
      }
      #emoji-picker {
          display: none;
          position: absolute;
          bottom: 70px;
          background: white;
          border: 1px solid #ce93d8;
          padding: 10px;
          border-radius: 10px;
      }
      .emoji {
          font-size: 20px;
          cursor: pointer;
          margin: 5px;
      }
      .delete-btn {
          background: none;
          border: none;
          color: #d81b60;
          font-weight: 600;
          margin-left: 10px;
          cursor: pointer;
          display: none;
      }
      .my-message .delete-btn {
          display: inline;
      }
      #users-list {
          padding: 20px;
          margin-top: 20px;
      }
      .user-item {
          display: flex;
          align-items: center;
          margin: 10px 0;
      }
      .user-item img {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Huiber <button id="profile-btn">–ü—Ä–æ—Ñ–∏–ª—å</button></h1>
    <div id="username-form" style="display: none;">
      <input type="text" id="username" placeholder="–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è" />
      <br />
      <input type="file" id="avatar" accept="image/*" />
      <br />
      <button id="save-btn" onclick="setUsername()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div id="profile-modal" style="display: none;">
      <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
      <input type="text" id="new-username" placeholder="–ù–æ–≤–æ–µ –∏–º—è" />
      <br />
      <input type="file" id="new-avatar" accept="image/*" />
      <br />
      <button id="save-profile-btn" onclick="updateProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div id="call-modal" style="display: none;">
      <h3 id="call-text">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç Huiber</h3>
      <button id="accept-call-btn" onclick="acceptCall()">–ü—Ä–∏–Ω—è—Ç—å</button>
      <button id="reject-call-btn" onclick="rejectCall()">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
    </div>
    <div id="call-window" style="display: none;">
      <h3>–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫</h3>
      <p id="call-participants"></p>
      <button id="end-call-btn" onclick="endCall()">–ü—Ä–µ—Ä–≤–∞—Ç—å</button>
    </div>
    <div id="chat-container" style="display: none;">
      <div id="chat">
        {% for msg in messages %}
        <div
          class="message"
          data-id="{{ msg.id }}"
          data-username="{{ msg.username }}"
        >
          {% if msg.username in users %}
          <img
            src="/static/uploads/{{ users[msg.username].avatar }}"
            class="avatar"
          />
          {% endif %}
          <span class="username">{{ msg.username }}:</span> {{ msg.text }} {% if
          msg.image %}
          <img src="/static/uploads/{{ msg.image }}" class="content-img" />
          {% endif %}
          <button class="delete-btn" onclick="deleteMessage('{{ msg.id }}')">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
        {% endfor %}
      </div>
      <div id="input-area">
        <input type="text" id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="emoji-btn">üòä</button>
        <input
          type="file"
          id="file-input"
          accept="image/*"
          style="display: none;"
        />
        <button
          id="file-btn"
          onclick="document.getElementById('file-input').click()"
        >
          üì∑
        </button>
        <button id="send-btn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div id="emoji-picker">
        <span class="emoji" onclick="addEmoji('üòä')">üòä</span>
        <span class="emoji" onclick="addEmoji('üòÇ')">üòÇ</span>
        <span class="emoji" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="emoji" onclick="addEmoji('üëç')">üëç</span>
        <span class="emoji" onclick="addEmoji('üò¢')">üò¢</span>
      </div>
    </div>
    <div id="users-list">
      <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
      <div id="users-content"></div>
    </div>
    <audio id="ringtone" src="/static/ringtone.mp3" loop></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script>
      const socket = io();
      let username = localStorage.getItem('username');
      let avatar = localStorage.getItem('avatar');
      let users = {};
      let peerConnection;
      let localStream;
      let currentTarget;
      const ringtone = document.getElementById('ringtone');

      if (!username) {
          document.getElementById('username-form').style.display = 'block';
      } else {
          document.getElementById('chat-container').style.display = 'block';
          updateMessageStyles();
          socket.emit('user_active', { username: username, avatar: avatar });
          socket.emit('get_users');
          requestNotificationPermission();
      }

      function requestNotificationPermission() {
          if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
              Notification.requestPermission().then(permission => {
                  if (permission === 'granted') {
                      console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–æ');
                  }
              });
          }
      }

      function setUsername() {
          username = document.getElementById('username').value.trim();
          const avatarInput = document.getElementById('avatar');
          if (username && avatarInput.files[0]) {
              const formData = new FormData();
              formData.append('file', avatarInput.files[0]);
              fetch('/upload', { method: 'POST', body: formData })
                  .then(response => response.text())
                  .then(filename => {
                      avatar = filename;
                      localStorage.setItem('username', username);
                      localStorage.setItem('avatar', avatar);
                      document.getElementById('username-form').style.display = 'none';
                      document.getElementById('chat-container').style.display = 'block';
                      updateMessageStyles();
                      socket.emit('user_active', { username: username, avatar: avatar });
                      socket.emit('get_users');
                      requestNotificationPermission();
                  });
          }
      }

      function updateProfile() {
          const newUsername = document.getElementById('new-username').value.trim();
          const newAvatarInput = document.getElementById('new-avatar');
          if (newUsername || newAvatarInput.files[0]) {
              if (newAvatarInput.files[0]) {
                  const formData = new FormData();
                  formData.append('file', newAvatarInput.files[0]);
                  fetch('/upload', { method: 'POST', body: formData })
                      .then(response => response.text())
                      .then(filename => {
                          username = newUsername || username;
                          avatar = filename;
                          localStorage.setItem('username', username);
                          localStorage.setItem('avatar', avatar);
                          document.getElementById('profile-modal').style.display = 'none';
                          updateMessageStyles();
                          socket.emit('user_active', { username: username, avatar: avatar });
                          socket.emit('get_users');
                          location.reload();
                      });
              } else {
                  username = newUsername || username;
                  localStorage.setItem('username', username);
                  document.getElementById('profile-modal').style.display = 'none';
                  updateMessageStyles();
                  socket.emit('user_active', { username: username, avatar: avatar });
                  socket.emit('get_users');
                  location.reload();
              }
          }
      }

      function replaceDenis(text) {
          return text.replace(/\b(–¥–µ–Ω–∏—Å|–î–µ–Ω–∏—Å|denis|Denis)\b/gi, 'xyecoc');
      }

      socket.on('new_message', function(msg) {
          const chat = document.getElementById('chat');
          const div = document.createElement('div');
          div.className = 'message';
          div.dataset.id = msg.id;
          div.dataset.username = msg.username;
          const avatarSrc = (msg.username === username && avatar) ? `/static/uploads/${avatar}` : (users[msg.username] ? `/static/uploads/${users[msg.username].avatar}` : '');
          const messageText = replaceDenis(msg.text);
          div.innerHTML = `${avatarSrc ? '<img src="' + avatarSrc + '" class="avatar">' : ''}<span class="username">${msg.username}:</span> ${messageText}${msg.image ? '<img src="/static/uploads/' + msg.image + '" class="content-img">' : ''}<button class="delete-btn" onclick="deleteMessage('${msg.id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
          chat.appendChild(div);
          updateMessageStyles();
          chat.scrollTop = chat.scrollHeight;

          if (msg.username !== username && 'Notification' in window && Notification.permission === 'granted' && document.hidden) {
              new Notification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${msg.username}`, {
                  body: messageText,
                  icon: avatarSrc || '/static/logo.png'
              });
          }
      });

      socket.on('message_deleted', function(data) {
          const msgElement = document.querySelector(`.message[data-id="${data.id}"]`);
          if (msgElement) msgElement.remove();
      });

      socket.on('users_list', function(users_data) {
          users = users_data;
          updateUsersList();
      });

      socket.on('update_users', function(users_data) {
          users = users_data;
          updateUsersList();
      });

      function updateUsersList() {
          const usersContent = document.getElementById('users-content');
          usersContent.innerHTML = '';
          for (const [user, info] of Object.entries(users)) {
              if (user !== username) {
                  const lastSeenUTC = new Date(info.last_seen);
                  const localOffset = new Date().getTimezoneOffset() * -1;
                  const lastSeenLocal = new Date(lastSeenUTC.getTime() + localOffset * 60 * 1000);
                  const lastSeenFormatted = lastSeenLocal.toLocaleString('ru-RU');
                  const div = document.createElement('div');
                  div.className = 'user-item';
                  div.innerHTML = `<img src="/static/uploads/${info.avatar}" class="avatar" alt="${user}'s avatar"><span>${user} ‚Äî –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –æ–Ω–ª–∞–π–Ω: ${lastSeenFormatted}</span><button class="call-user-btn" onclick="callUser('${user}')">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>`;
                  usersContent.appendChild(div);
              }
          }
      }

      function sendMessage() {
          const input = document.getElementById('message');
          const fileInput = document.getElementById('file-input');
          const text = input.value.trim();
          if ((text || fileInput.files[0]) && username) {
              if (fileInput.files[0]) {
                  const formData = new FormData();
                  formData.append('file', fileInput.files[0]);
                  fetch('/upload', { method: 'POST', body: formData })
                      .then(response => response.text())
                      .then(filename => {
                          socket.emit('send_message', { message: text, username: username, image: filename });
                          input.value = '';
                          fileInput.value = '';
                          socket.emit('user_active', { username: username, avatar: avatar });
                      });
              } else {
                  socket.emit('send_message', { message: text, username: username });
                  input.value = '';
                  socket.emit('user_active', { username: username, avatar: avatar });
              }
          }
      }

      function deleteMessage(id) {
          socket.emit('delete_message', { id: id, username: username });
      }

      function updateMessageStyles() {
          const messages = document.querySelectorAll('.message');
          messages.forEach(msg => {
              const msgUsername = msg.dataset.username;
              msg.classList.toggle('my-message', msgUsername === username);
              msg.classList.toggle('other-message', msgUsername !== username);
          });
      }

      document.getElementById('message').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') sendMessage();
      });

      document.getElementById('profile-btn').addEventListener('click', function() {
          document.getElementById('profile-modal').style.display = 'block';
          document.getElementById('new-username').value = username;
      });

      document.getElementById('emoji-btn').addEventListener('click', function() {
          const picker = document.getElementById('emoji-picker');
          picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
      });

      function addEmoji(emoji) {
          document.getElementById('message').value += emoji;
          document.getElementById('emoji-picker').style.display = 'none';
      }

      // WebRTC –ª–æ–≥–∏–∫–∞
      const configuration = {
          iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' },
              { urls: 'stun:stun2.l.google.com:19302' }
          ]
      };

      async function callUser(target) {
          if (!username) return;
          currentTarget = target;

          localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          peerConnection = new RTCPeerConnection(configuration);

          localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

          peerConnection.onicecandidate = event => {
              if (event.candidate) {
                  socket.emit('ice_candidate', { target: currentTarget, candidate: event.candidate, caller: username });
              }
          };

          peerConnection.ontrack = event => {
              const audio = new Audio();
              audio.srcObject = event.streams[0];
              audio.autoplay = true;
              audio.id = `audio-${currentTarget}`;
              document.body.appendChild(audio);
              document.getElementById('call-participants').textContent = `–£—á–∞—Å—Ç–Ω–∏–∫–∏: ${currentTarget}`;
              document.getElementById('call-window').style.display = 'block';
          };

          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);
          socket.emit('call_user', { caller: username, target: currentTarget });
          socket.emit('offer', { offer: offer, target: currentTarget, caller: username });
      }

      socket.on('incoming_call', async function(data) {
          currentTarget = data.caller;
          document.getElementById('call-text').textContent = `–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç Huiber (${currentTarget})`;
          document.getElementById('call-modal').style.display = 'block';
          ringtone.play();
      });

      async function acceptCall() {
          document.getElementById('call-modal').style.display = 'none';
          ringtone.pause();
          ringtone.currentTime = 0;

          localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          peerConnection = new RTCPeerConnection(configuration);

          localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

          peerConnection.onicecandidate = event => {
              if (event.candidate) {
                  socket.emit('ice_candidate', { target: currentTarget, candidate: event.candidate, caller: username });
              }
          };

          peerConnection.ontrack = event => {
              const audio = new Audio();
              audio.srcObject = event.streams[0];
              audio.autoplay = true;
              audio.id = `audio-${currentTarget}`;
              document.body.appendChild(audio);
              document.getElementById('call-participants').textContent = `–£—á–∞—Å—Ç–Ω–∏–∫–∏: ${currentTarget}`;
              document.getElementById('call-window').style.display = 'block';
          };

          socket.on('offer', async function(data) {
              if (data.caller === currentTarget) {
                  await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                  const answer = await peerConnection.createAnswer();
                  await peerConnection.setLocalDescription(answer);
                  socket.emit('answer', { answer: answer, target: currentTarget, caller: username });
              }
          });

          socket.on('answer', async function(data) {
              if (data.target === username && peerConnection) {
                  await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
              }
          });

          socket.on('ice_candidate', async function(data) {
              if (data.caller === currentTarget && peerConnection) {
                  try {
                      await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                  } catch (e) {
                      console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE candidate:', e);
                  }
              }
          });
      }

      function rejectCall() {
          document.getElementById('call-modal').style.display = 'none';
          ringtone.pause();
          ringtone.currentTime = 0;
          currentTarget = null;
      }

      function endCall() {
          if (peerConnection) {
              peerConnection.close();
              peerConnection = null;
          }
          if (localStream) {
              localStream.getTracks().forEach(track => track.stop());
          }
          const audio = document.getElementById(`audio-${currentTarget}`);
          if (audio) audio.remove();
          document.getElementById('call-window').style.display = 'none';
          ringtone.pause();
          ringtone.currentTime = 0;
          currentTarget = null;
      }

      setInterval(() => {
          if (username) {
              socket.emit('user_active', { username: username, avatar: avatar });
              socket.emit('get_users');
          }
      }, 10000);
    </script>
  </body>
</html>
