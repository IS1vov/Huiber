<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞—Ç–µ–≥ viewport –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Huiber</title>
    <link rel="icon" type="image/png" href="/static/logo.png" />
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <style>
      /* --- –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin: 0;
          background: url('/static/background.png') no-repeat center center fixed;
          background-size: cover;
          display: flex;
          flex-direction: column;
          align-items: center;
          color: #FFFFFF;
      }
      h1 {
          font-size: 28px;
          color: #2E7D32;
          margin: 25px 0;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          position: relative;
          text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }
      h1 button#profile-btn {
           font-size: 16px;
           margin-left: 15px;
           padding: 8px 12px;
           background-color: #A5D6A7;
           color: #2E7D32;
           border: none;
           border-radius: 20px;
           cursor: pointer;
           transition: background-color 0.2s ease;
           box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      h1 button#profile-btn:hover {
          background-color: #81C784;
      }

      #chat-container, #username-form, #profile-modal, #users-list, #call-modal, #call-window {
          width: 100%;
          max-width: 650px;
          background: rgba(255, 255, 255, 0.92);
          border: 1px solid #B0BEC5;
          border-radius: 18px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          margin-bottom: 20px;
          display: flex;
          flex-direction: column;
      }

      #username-form, #profile-modal, #call-modal, #call-window {
          padding: 35px;
          text-align: center;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          display: none;
          z-index: 1000;
          width: 90%;
          max-width: 450px;
          flex-direction: column;
          align-items: center;
      }
       #username-form h3, #profile-modal h3, #call-modal h3, #call-window h3 {
           margin-top: 0;
           margin-bottom: 20px;
           color: #2E7D32;
           font-size: 20px;
       }
        #username-form p {
           margin-bottom: 15px;
           color: #455A64;
        }

       #username, #avatar, #new-username, #new-avatar {
          padding: 12px 15px;
          border: 1px solid #B0BEC5;
          border-radius: 8px;
          width: calc(100% - 32px);
          margin-bottom: 15px;
          box-sizing: border-box;
          font-size: 15px;
          color: #455A64;
       }
       label.file-input-label {
           padding: 10px 15px;
           background-color: #E8F5E9;
           color: #2E7D32;
           border: 1px dashed #B0BEC5;
           border-radius: 8px;
           cursor: pointer;
           margin-bottom: 15px;
           transition: background-color 0.2s ease;
       }
       label.file-input-label:hover {
           background-color: #C8E6C9;
       }
       img.avatar-preview {
           max-width: 100px;
           max-height: 100px;
           border-radius: 50%;
           margin-bottom: 15px;
           display: none;
           border: 2px solid #B0BEC5;
           padding: 3px;
           background-color: white;
       }

       #save-btn, #save-profile-btn, #accept-call-btn, #reject-call-btn, #end-call-btn, .modal-cancel-btn {
          background-color: #2E7D32;
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 8px;
          cursor: pointer;
          margin: 10px 5px 0;
          font-size: 15px;
          font-weight: 500;
          transition: background-color 0.2s ease, box-shadow 0.2s ease;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
       }
       #save-btn:hover, #save-profile-btn:hover, #accept-call-btn:hover, #reject-call-btn:hover, #end-call-btn:hover, .modal-cancel-btn:hover {
          background-color: #1B5E20;
          box-shadow: 0 3px 6px rgba(0,0,0,0.15);
       }
        #accept-call-btn { background-color: #4CAF50; }
        #accept-call-btn:hover { background-color: #388E3C; }
        #reject-call-btn, #end-call-btn { background-color: #F44336; }
        #reject-call-btn:hover, #end-call-btn:hover { background-color: #D32F2F; }
        .modal-cancel-btn { background-color: #B0BEC5; }
        .modal-cancel-btn:hover { background-color: #90A4AE; }

      #chat {
          flex-grow: 1;
          height: 450px;
          overflow-y: auto;
          padding: 20px;
          background: #E8F5E9;
          border-bottom: 1px solid #C8E6C9;
          border-top-left-radius: 18px;
          border-top-right-radius: 18px;
          display: flex;
          flex-direction: column;
      }
       #chat:empty::before {
           content: "–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...";
           display: block;
           text-align: center;
           color: #2E7D32;
           padding: 50px 0;
           font-style: italic;
       }

      .message {
          margin-bottom: 12px;
          padding: 10px 15px;
          border-radius: 18px;
          max-width: 78%;
          word-wrap: break-word;
          display: flex;
          align-items: flex-start;
          line-height: 1.45;
          position: relative;
      }
      .my-message {
          background-color: #2E7D32;
          color: white;
          margin-left: auto;
          border-bottom-right-radius: 5px;
          flex-direction: row-reverse;
      }
      .other-message {
          background-color: #A5D6A7;
          color: #263238;
          margin-right: auto;
          border-bottom-left-radius: 5px;
          flex-direction: row;
      }
      .avatar {
          width: 35px;
          height: 35px;
          border-radius: 50%;
          border: 1px solid rgba(0, 0, 0, 0.1);
          margin: 0 10px;
          flex-shrink: 0;
      }
      .my-message .avatar { margin-left: 10px; margin-right: 0; }
      .other-message .avatar { margin-right: 10px; margin-left: 0; }

       .message-content-wrapper {
           display: flex;
           flex-direction: column;
           flex-grow: 1;
       }
      .username {
          font-weight: 600;
          font-size: 13px;
          margin-bottom: 3px;
          color: rgba(0, 0, 0, 0.6);
      }
      .my-message .username {
           color: rgba(255, 255, 255, 0.8);
           text-align: right;
      }
       .message-text {
          font-size: 15px;
       }
      .message img.content-img {
          max-width: 100%;
          max-height: 300px;
          object-fit: cover;
          border-radius: 10px;
          margin-top: 8px;
          cursor: pointer;
          border: 1px solid rgba(0,0,0,0.1);
      }
      .delete-btn {
          background: none;
          border: none;
          color: rgba(255, 255, 255, 0.6);
          font-weight: normal;
          position: absolute;
          top: 5px;
          right: 8px;
          cursor: pointer;
          display: none;
          font-size: 16px;
          padding: 2px;
          line-height: 1;
          opacity: 0.7;
          transition: opacity 0.2s ease;
      }
      .my-message:hover .delete-btn {
          display: block;
      }
      .delete-btn:hover {
          opacity: 1.0;
          color: #FFCDD2;
      }

      #input-area {
          display: flex;
          padding: 15px 20px;
          border-top: 1px solid #B0BEC5;
          align-items: center;
          background: rgba(255, 255, 255, 0.95);
          border-bottom-left-radius: 18px;
          border-bottom-right-radius: 18px;
      }
      #message {
          flex: 1;
          padding: 12px 18px;
          border: 1px solid #B0BEC5;
          border-radius: 25px;
          outline: none;
          font-size: 15px;
          background: #fff;
          margin-right: 10px;
          resize: none;
          min-height: 20px;
          max-height: 100px;
          overflow-y: auto;
          color: #263238;
      }
      #input-area button {
          background: none;
          border: none;
          color: #2E7D32;
          font-size: 24px;
          margin-left: 8px;
          cursor: pointer;
          padding: 5px;
          transition: color 0.2s ease, transform 0.1s ease;
          line-height: 1;
      }
      #input-area button:hover {
          color: #1B5E20;
      }
      #input-area button:active {
          transform: scale(0.9);
      }
      #send-btn {
          font-weight: bold;
      }
      #message-preview-container {
          padding: 0 20px 10px;
          text-align: left;
          display: none;
          background: rgba(255, 255, 255, 0.95);
      }
      #message-preview {
          max-width: 80px;
          max-height: 80px;
          border-radius: 5px;
          margin-top: 5px;
          border: 1px solid #E0E0E0;
      }
      #message-preview-container button {
          font-size: 16px;
          background: none;
          border: none;
          color: #B0BEC5;
          cursor: pointer;
          padding: 0 5px;
          margin-left: 5px;
          vertical-align: middle;
      }
      #message-preview-container button:hover {
          color: #F44336;
      }

      #emoji-picker {
          display: none;
          position: absolute;
          bottom: 75px;
          right: 20px;
          background: white;
          border: 1px solid #B0BEC5;
          padding: 15px;
          border-radius: 10px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
          z-index: 1001;
          width: auto;
          max-width: 300px;
      }
      .emoji {
          font-size: 26px;
          cursor: pointer;
          margin: 4px 6px;
          display: inline-block;
          transition: transform 0.1s ease;
      }
      .emoji:hover {
          transform: scale(1.2);
      }

      #users-list {
          padding: 20px 25px;
          margin-top: 0;
          border-top-left-radius: 0;
          border-top-right-radius: 0;
          border-top: 1px solid #E8F5E9;
          background: rgba(255, 255, 255, 0.9);
          border-bottom-left-radius: 18px;
          border-bottom-right-radius: 18px;
      }
      #users-list h3 {
          margin-top: 0;
          margin-bottom: 15px;
          color: #2E7D32;
          border-bottom: 1px solid #C8E6C9;
          padding-bottom: 10px;
          font-size: 18px;
      }
      #users-content:empty::before {
          content: "–î—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç –æ–Ω–ª–∞–π–Ω";
          display: block;
          text-align: center;
          color: #2E7D32;
          padding: 20px 0;
          font-style: italic;
      }
      .user-item {
          display: flex;
          align-items: center;
          margin-bottom: 12px;
          padding: 10px;
          border-radius: 10px;
          transition: background-color 0.2s ease;
          position: relative;
      }
      .user-item:hover {
          background-color: #E8F5E9;
      }
      .user-item img.avatar {
          width: 45px;
          height: 45px;
          margin-right: 15px;
          border: 2px solid transparent;
      }
      .user-item img.avatar.online { border-color: #4CAF50; }
      .user-item img.avatar.offline { border-color: #B0BEC5; }

      .user-item .user-info {
          flex-grow: 1;
      }
      .user-item span.username-in-list {
          font-size: 15px;
          font-weight: 500;
          color: #2E7D32;
          display: block;
      }
      .user-item .last-seen {
          font-size: 11px;
          color: #455A64;
          display: block;
          margin-top: 2px;
      }
      .user-item .last-seen.online { color: #4CAF50; font-weight: 500; }
      .user-item .last-seen.offline { color: #B0BEC5; }

      .call-user-btn {
          background-color: #4CAF50;
          color: white;
          padding: 8px 10px;
          border-radius: 50%;
          font-size: 18px;
          margin-left: 15px;
          cursor: pointer;
          border: none;
          transition: background-color 0.2s ease, transform 0.1s ease;
          line-height: 1;
          flex-shrink: 0;
      }
      .call-user-btn:hover {
          background-color: #388E3C;
      }
      .call-user-btn:active {
          transform: scale(0.9);
      }

      #call-window {
          background-color: #E8F5E9;
          border-color: #A5D6A7;
      }
      #call-window h3 {
          color: #2E7D32;
      }
      #call-participants {
          margin: 15px 0;
          font-weight: 500;
          color: #1B5E20;
          min-height: 20px;
      }
      .connecting-indicator {
          display: none;
          margin: 10px auto;
          border: 5px solid #F5F5F5;
          border-top: 5px solid #2E7D32;
          border-radius: 50%;
          width: 35px;
          height: 35px;
          animation: spin 1.2s linear infinite;
      }
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      #remote-audio {
          display: none;
      }

      #imageModal {
          display: none;
          position: fixed;
          z-index: 2000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(0,0,0,0.85);
          cursor: pointer;
      }
      #modalImage {
          margin: auto;
          display: block;
          max-width: 90%;
          max-height: 85%;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          border-radius: 5px;
          cursor: default;
      }
      #imageModal .close-modal-btn {
          position: absolute;
          top: 15px;
          right: 30px;
          color: #F1F1F1;
          font-size: 45px;
          font-weight: bold;
          cursor: pointer;
          transition: color 0.2s ease;
          line-height: 1;
      }
      #imageModal .close-modal-btn:hover {
          color: #BBB;
      }

      /* --- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ --- */
      @media (max-width: 768px) {
          body {
              padding: 0 10px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –ø–æ –±–æ–∫–∞–º */
          }

          h1 {
              font-size: 22px; /* –£–º–µ–Ω—å—à–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
              margin: 15px 0;
              flex-wrap: wrap; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å */
              justify-content: space-between;
          }
          h1 button#profile-btn {
              font-size: 14px;
              padding: 6px 10px;
              margin-left: 10px;
          }

          #chat-container, #users-list {
              max-width: 100%; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
              margin-bottom: 10px;
              border-radius: 12px; /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–¥–∏—É—Å */
          }

          #chat {
              height: 60vh; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É —á–∞—Ç–∞ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —ç–∫—Ä–∞–Ω—É */
              padding: 15px;
          }

          .message {
              max-width: 85%; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏–π */
              padding: 8px 12px;
          }
          .avatar {
              width: 30px;
              height: 30px;
              margin: 0 8px;
          }
          .username {
              font-size: 12px;
          }
          .message-text {
              font-size: 14px;
          }
          .message img.content-img {
              max-height: 200px; /* –£–º–µ–Ω—å—à–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
          }

          #input-area {
              padding: 10px 15px;
              flex-wrap: wrap; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –∫–Ω–æ–ø–æ–∫ */
          }
          #message {
              padding: 10px 15px;
              font-size: 14px;
              margin-right: 5px;
              max-height: 80px;
          }
          #input-area button {
              font-size: 20px;
              margin-left: 5px;
              padding: 3px;
          }
          #message-preview-container {
              padding: 0 15px 8px;
          }
          #message-preview {
              max-width: 60px;
              max-height: 60px;
          }

          #emoji-picker {
              bottom: 60px;
              right: 15px;
              padding: 10px;
              max-width: 90%; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
          }
          .emoji {
              font-size: 22px;
              margin: 3px 5px;
          }

          #username-form, #profile-modal, #call-modal, #call-window {
              padding: 20px;
              width: 90%;
              max-width: 100%; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
          }
          #username-form h3, #profile-modal h3, #call-modal h3, #call-window h3 {
              font-size: 18px;
              margin-bottom: 15px;
          }
          #username, #avatar, #new-username, #new-avatar {
              padding: 10px 12px;
              font-size: 14px;
          }
          label.file-input-label {
              padding: 8px 12px;
              font-size: 14px;
          }
          img.avatar-preview {
              max-width: 80px;
              max-height: 80px;
          }
          #save-btn, #save-profile-btn, #accept-call-btn, #reject-call-btn, #end-call-btn, .modal-cancel-btn {
              padding: 10px 20px;
              font-size: 14px;
              margin: 5px 3px;
          }

          #users-list {
              padding: 15px 20px;
          }
          #users-list h3 {
              font-size: 16px;
              padding-bottom: 8px;
          }
          .user-item {
              padding: 8px;
              margin-bottom: 10px;
          }
          .user-item img.avatar {
              width: 40px;
              height: 40px;
              margin-right: 10px;
          }
          .user-item span.username-in-list {
              font-size: 14px;
          }
          .user-item .last-seen {
              font-size: 10px;
          }
          .call-user-btn {
              padding: 6px 8px;
              font-size: 16px;
              margin-left: 10px;
          }

          #imageModal .close-modal-btn {
              font-size: 35px;
              top: 10px;
              right: 20px;
          }
      }

      /* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ (–º–µ–Ω–µ–µ 480px) */
      @media (max-width: 480px) {
          h1 {
              font-size: 20px;
              flex-direction: column;
              align-items: center;
          }
          h1 button#profile-btn {
              margin-left: 0;
              margin-top: 10px;
          }

          #chat {
              height: 50vh;
          }

          .message {
              padding: 6px 10px;
          }
          .avatar {
              width: 25px;
              height: 25px;
              margin: 0 6px;
          }
          .username {
              font-size: 11px;
          }
          .message-text {
              font-size: 13px;
          }

          #input-area {
              padding: 8px 10px;
          }
          #message {
              padding: 8px 12px;
              font-size: 13px;
          }
          #input-area button {
              font-size: 18px;
              margin-left: 3px;
          }

          #emoji-picker {
              bottom: 50px;
              right: 10px;
          }
          .emoji {
              font-size: 20px;
              margin: 2px 4px;
          }
      }
    </style>
  </head>

  <body>
    <h1>Huiber <button id="profile-btn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button></h1>

    <div id="username-form" style="display: none;">
      <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
      <p>–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:</p>
      <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è" required />
      <br />
      <label for="avatar" class="file-input-label">üì∑ –í—ã–±—Ä–∞—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
      <input
        type="file"
        id="avatar"
        accept="image/*"
        style="display: none;"
        required
      />
      <br />
      <img
        id="avatar-preview"
        src="#"
        alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∞"
        class="avatar-preview"
      />
      <br />
      <button id="save-btn" onclick="setUsername()">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
    </div>

    <div id="profile-modal" style="display: none;">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
      <input type="text" id="new-username" placeholder="–ù–æ–≤–æ–µ –∏–º—è" />
      <br />
      <label for="new-avatar" class="file-input-label">üì∑ –°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
      <input
        type="file"
        id="new-avatar"
        accept="image/*"
        style="display: none;"
      />
      <br />
      <img
        id="new-avatar-preview"
        src="#"
        alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–æ–≤–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞"
        class="avatar-preview"
      />
      <br />
      <button id="save-profile-btn" onclick="updateProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button
        class="modal-cancel-btn"
        onclick="document.getElementById('profile-modal').style.display = 'none'"
      >
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>

    <div id="call-modal" style="display: none;">
      <h3 id="call-text">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...</h3>
      <p style="font-size: 40px;">üìû</p>
      <button id="accept-call-btn" onclick="acceptCall()">–ü—Ä–∏–Ω—è—Ç—å</button>
      <button id="reject-call-btn" onclick="rejectCall()">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
    </div>

    <div id="call-window" style="display: none;">
      <h3>üîä –ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫</h3>
      <div class="connecting-indicator" id="connecting-indicator"></div>
      <p id="call-participants">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</p>
      <audio
        id="remote-audio"
        autoplay
        playsinline
        style="display: none;"
      ></audio>
      <button id="end-call-btn" onclick="endCall()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

    <div id="chat-container" style="display: none;">
      <div id="chat"></div>
      <div id="input-area">
        <input type="text" id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="emoji-btn" title="–≠–º–æ–¥–∑–∏">üòä</button>
        <input
          type="file"
          id="file-input"
          accept="image/*"
          style="display: none;"
          onchange="previewImage(event, 'message-preview-container')"
        />
        <button
          id="file-btn"
          onclick="document.getElementById('file-input').click()"
          title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ"
        >
          üì∑
        </button>
        <button id="send-btn" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
          ‚û§
        </button>
      </div>
      <div id="message-preview-container">
        <img id="message-preview" src="#" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" />
        <button onclick="clearMessagePreview()" title="–£–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
          ‚úñ
        </button>
      </div>
      <div id="emoji-picker">
        <span class="emoji" onclick="addEmoji('üòä')">üòä</span>
        <span class="emoji" onclick="addEmoji('üòÇ')">üòÇ</span>
        <span class="emoji" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="emoji" onclick="addEmoji('üëç')">üëç</span>
        <span class="emoji" onclick="addEmoji('üò¢')">üò¢</span>
        <span class="emoji" onclick="addEmoji('ü§î')">ü§î</span>
        <span class="emoji" onclick="addEmoji('üéâ')">üéâ</span>
        <span class="emoji" onclick="addEmoji('üî•')">üî•</span>
        <span class="emoji" onclick="addEmoji('üëã')">üëã</span>
        <span class="emoji" onclick="addEmoji('üôè')">üôè</span>
        <span class="emoji" onclick="addEmoji('üëÄ')">üëÄ</span>
        <span class="emoji" onclick="addEmoji('‚ú®')">‚ú®</span>
        <span class="emoji" onclick="addEmoji('—ù')">—ù</span>
      </div>
    </div>

    <div id="users-list" style="display: none;">
      <h3>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω</h3>
      <div id="users-content"></div>
    </div>

    <audio id="ringtone" src="/static/ringtone.mp3" loop></audio>

    <div id="imageModal" onclick="closeImageModal()">
      <span class="close-modal-btn" onclick="closeImageModal(event)">√ó</span>
      <img id="modalImage" onclick="event.stopPropagation()" />
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script>
      // –û—Å—Ç–∞–≤–ª—è–µ–º JavaScript –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É
      const socket = io();
      let username = localStorage.getItem('username');
      let avatar = localStorage.getItem('avatar');
      let users = {};

      let peerConnection;
      let localStream;
      let currentTarget = null;
      let receivedOffer = null;
      const ringtone = document.getElementById('ringtone');
      const remoteAudio = document.getElementById('remote-audio');

      const configuration = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' }
        ]
      };

      document.addEventListener('DOMContentLoaded', () => {
          if (!username || !avatar) {
              showLogin();
          } else {
              showChat();
              initializeChat();
          }
      });

      function showLogin() {
          hideElement('chat-container');
          hideElement('users-list');
          showElement('username-form');
          document.getElementById('avatar').onchange = (event) => {
              previewImage(event, 'avatar-preview');
          };
      }

      function showChat() {
          hideElement('username-form');
          showElement('chat-container');
          showElement('users-list');
          document.getElementById('users-list').style.marginTop = '0';
      }

      function showElement(id) {
          const el = document.getElementById(id);
          if (el) el.style.display = 'flex';
          if (['username-form', 'profile-modal', 'call-modal', 'call-window', 'imageModal'].includes(id)) {
              el.style.display = 'flex';
          }
      }
      function hideElement(id) {
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
      }

      function initializeChat() {
          console.log("Initializing chat for user:", username);
          updateMessageStyles();
          socket.connect();
          socket.emit('user_active', { username: username, avatar: avatar });
          socket.emit('get_users');
          socket.emit('get_messages');
          requestNotificationPermission();
          setupGlobalListeners();
          startActivityPing();
      }

      let activityPingInterval;
      function startActivityPing() {
          clearInterval(activityPingInterval);
          activityPingInterval = setInterval(() => {
              if (socket.connected && username) {
                  socket.emit('user_active', { username: username, avatar: avatar });
              }
          }, 30000);
      }

      function setUsername() {
          const usernameInput = document.getElementById('username');
          const avatarInput = document.getElementById('avatar');
          const potentialUsername = usernameInput.value.trim();
          const avatarFile = avatarInput.files[0];

          if (potentialUsername && avatarFile) {
              if (potentialUsername.length < 3 || potentialUsername.length > 15) {
                  alert("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤.");
                  return;
              }
              if (!/^[a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å_-]+$/.test(potentialUsername)) {
                  alert("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _ –∏ -.");
                  return;
              }

              const formData = new FormData();
              formData.append('file', avatarFile);

              const saveBtn = document.getElementById('save-btn');
              saveBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
              saveBtn.disabled = true;

              fetch('/upload', { method: 'POST', body: formData })
                  .then(response => {
                      if (!response.ok) throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
                      return response.text();
                  })
                  .then(filename => {
                      username = potentialUsername;
                      avatar = filename;
                      localStorage.setItem('username', username);
                      localStorage.setItem('avatar', avatar);
                      showChat();
                      initializeChat();
                  })
                  .catch(error => {
                      console.error('Error setting username/avatar:', error);
                      alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`);
                  })
                  .finally(() => {
                      saveBtn.textContent = '–í–æ–π—Ç–∏ –≤ —á–∞—Ç';
                      saveBtn.disabled = false;
                  });
          } else {
              alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä.');
          }
      }

      function updateProfile() {
          const newUsernameInput = document.getElementById('new-username');
          const newAvatarInput = document.getElementById('new-avatar');
          const newUsername = newUsernameInput.value.trim();
          const newAvatarFile = newAvatarInput.files[0];

          let updateData = {};
          let needsReload = false;
          const oldUsername = localStorage.getItem('username');

          if (newUsername && newUsername !== oldUsername) {
              if (newUsername.length < 3 || newUsername.length > 15) {
                  alert("–ù–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤.");
                  return;
              }
              if (!/^[a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å_-]+$/.test(newUsername)) {
                  alert("–ù–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _ –∏ -.");
                  return;
              }
              updateData.username = newUsername;
              needsReload = true;
          }

          const handleUpdate = (updatedAvatarFilename = null) => {
              if (updateData.username) {
                  localStorage.setItem('username', updateData.username);
                  username = updateData.username;
              }
              if (updatedAvatarFilename) {
                  updateData.avatar = updatedAvatarFilename;
                  localStorage.setItem('avatar', updatedAvatarFilename);
                  avatar = updatedAvatarFilename;
              }

              if (Object.keys(updateData).length > 0) {
                  console.log("Updating profile on server:", { username: username, avatar: avatar });
                  socket.emit('user_active', { username: username, avatar: avatar });
                  alert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                  hideElement('profile-modal');
                  document.getElementById('new-username').value = '';
                  document.getElementById('new-avatar').value = '';
                  document.getElementById('new-avatar-preview').style.display = 'none';
                  document.getElementById('new-avatar-preview').src = '#';

                  if (needsReload) {
                      console.log("Username changed, reloading page...");
                      location.reload();
                  } else {
                      updateMessageStyles();
                      updateUsersList();
                  }
              } else {
                  hideElement('profile-modal');
              }
          };

          const saveProfileBtn = document.getElementById('save-profile-btn');

          if (newAvatarFile) {
              saveProfileBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
              saveProfileBtn.disabled = true;
              const formData = new FormData();
              formData.append('file', newAvatarFile);
              fetch('/upload', { method: 'POST', body: formData })
                  .then(response => {
                      if (!response.ok) throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
                      return response.text();
                  })
                  .then(filename => handleUpdate(filename))
                  .catch(error => {
                      console.error('Error updating profile avatar:', error);
                      alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞: ${error.message}.`);
                  })
                  .finally(() => {
                      saveProfileBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                      saveProfileBtn.disabled = false;
                  });
          } else {
              handleUpdate();
          }
      }

      function replaceDenis(text) {
          return text.replace(/\b(–¥–µ–Ω–∏—Å|denis)\b/gi, '–•–£–ï–°–û–°');
      }

      function renderMessage(msg, prepend = false) {
          const chat = document.getElementById('chat');
          if (!chat) return;

          if (document.querySelector(`.message[data-id="${msg.id}"]`)) {
              console.warn(`Message with ID ${msg.id} already exists. Skipping render.`);
              return;
          }

          const isScrolledToBottom = chat.scrollHeight - chat.clientHeight <= chat.scrollTop + 100;

          const div = document.createElement('div');
          div.className = 'message';
          div.dataset.id = msg.id;
          div.dataset.username = msg.username;

          const userAvatarFilename = users[msg.username]?.avatar || null;
          const avatarSrc = userAvatarFilename ? `/static/uploads/${userAvatarFilename}` : '/static/logo.png';
          const defaultAvatarOnError = '/static/logo.png';

          const messageText = replaceDenis(msg.text || "");

          let imageHTML = '';
          if (msg.image) {
              const imageSrc = `/static/uploads/${msg.image}`;
              imageHTML = `<img src="${imageSrc}" class="content-img" onclick="openImageModal('${imageSrc}')" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç ${msg.username || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}">`;
          }

          let deleteButtonHTML = '';
          if (msg.username === username) {
              deleteButtonHTML = `<button class="delete-btn" onclick="deleteMessage('${msg.id}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>`;
          }

          div.innerHTML = `
              <img src="${avatarSrc}" class="avatar" alt="${msg.username}'s avatar" onerror="this.onerror=null;this.src='${defaultAvatarOnError}';">
              <div class="message-content-wrapper">
                  <span class="username">${msg.username || '–ê–Ω–æ–Ω–∏–º'}:</span>
                  <span class="message-text">${messageText}</span>
                  ${imageHTML}
              </div>
              ${deleteButtonHTML}
          `;

          if (prepend) {
              chat.insertBefore(div, chat.firstChild);
          } else {
              chat.appendChild(div);
          }

          updateSingleMessageStyle(div);

          if (!prepend && isScrolledToBottom) {
              chat.scrollTop = chat.scrollHeight;
          }
      }

      function sendMessage() {
          const input = document.getElementById('message');
          const fileInput = document.getElementById('file-input');
          const text = input.value.trim();
          const file = fileInput.files[0];

          if ((text || file) && username) {
              const sendMessageData = (imageData = null) => {
                  console.log(`Sending message: Text='${text}', Image='${imageData}'`);
                  socket.emit('send_message', {
                      message: text,
                      username: username,
                      image: imageData
                  });
                  input.value = '';
                  fileInput.value = '';
                  clearMessagePreview();
              };

              if (file) {
                  const sendBtn = document.getElementById('send-btn');
                  sendBtn.disabled = true;

                  const formData = new FormData();
                  formData.append('file', file);
                  fetch('/upload', { method: 'POST', body: formData })
                      .then(response => {
                          if (!response.ok) throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
                          return response.text();
                      })
                      .then(filename => sendMessageData(filename))
                      .catch(error => {
                          console.error('Error uploading image:', error);
                          alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${error.message}.`);
                          clearMessagePreview();
                      })
                      .finally(() => {
                          sendBtn.disabled = false;
                      });
              } else {
                  sendMessageData();
              }
          }
      }

      function deleteMessage(id) {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
              console.log(`Requesting deletion of message ID: ${id} by user: ${username}`);
              socket.emit('delete_message', { id: id, username: username });
          }
      }

      function updateMessageStyles() {
          const messages = document.querySelectorAll('.message');
          messages.forEach(msg => updateSingleMessageStyle(msg));
          const chat = document.getElementById('chat');
          if(chat) chat.scrollTop = chat.scrollHeight;
      }

      function updateSingleMessageStyle(msgElement) {
          if (!msgElement || !msgElement.dataset) return;
          const msgUsername = msgElement.dataset.username;
          const isMy = msgUsername === username;
          msgElement.classList.toggle('my-message', isMy);
          msgElement.classList.toggle('other-message', !isMy);

          const deleteBtn = msgElement.querySelector('.delete-btn');
          if(deleteBtn){
              deleteBtn.style.display = isMy ? '' : 'none';
          }
          const avatarImg = msgElement.querySelector('.avatar');
          if (avatarImg) {
              const userAvatarFilename = users[msgUsername]?.avatar || null;
              avatarImg.src = userAvatarFilename ? `/static/uploads/${userAvatarFilename}` : '/static/logo.png';
          }
      }

      function updateUsersList() {
          console.log("Updating users list display with data:", users);
          const usersContent = document.getElementById('users-content');
          if (!usersContent) return;
          usersContent.innerHTML = '';

          const now = new Date();
          const onlineThreshold = 60 * 1000;

          let hasOtherUsers = false;
          Object.entries(users).forEach(([user, info]) => {
              if (user === username) return;
              hasOtherUsers = true;

              const div = document.createElement('div');
              div.className = 'user-item';
              div.id = `user-${user}`;

              const avatarFilename = info.avatar || null;
              const avatarSrc = avatarFilename ? `/static/uploads/${avatarFilename}` : '/static/logo.png';
              const defaultAvatarOnError = '/static/logo.png';

              let statusText = '–û—Ñ–ª–∞–π–Ω';
              let statusClass = 'offline';

              if (info.last_seen) {
                  try {
                      const lastSeenDate = new Date(info.last_seen);
                      const timeDiff = now.getTime() - lastSeenDate.getTime();

                      if (!isNaN(timeDiff) && timeDiff < onlineThreshold) {
                          statusText = '–û–Ω–ª–∞–π–Ω';
                          statusClass = 'online';
                      } else if (!isNaN(lastSeenDate.getTime())) {
                          statusText = `–ë—ã–ª(–∞) ${lastSeenDate.toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' })}`;
                      } else {
                          statusText = "–°—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω";
                      }
                  } catch (e) {
                      console.error("Error parsing date for user", user, info.last_seen, e);
                      statusText = "–°—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω";
                  }
              } else {
                  statusText = "–°—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω";
              }

              const callButtonHTML = statusClass === 'online'
                  ? `<button class="call-user-btn" onclick="callUser('${user}')" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å ${user}">üìû</button>`
                  : '';

              div.innerHTML = `
                  <img src="${avatarSrc}" class="avatar ${statusClass}" alt="${user}'s avatar" onerror="this.onerror=null;this.src='${defaultAvatarOnError}';">
                  <div class="user-info">
                      <span class="username-in-list">${user}</span>
                      <span class="last-seen ${statusClass}">${statusText}</span>
                  </div>
                  ${callButtonHTML}
              `;

              usersContent.appendChild(div);
          });

          if (!hasOtherUsers) {
              usersContent.innerHTML = '<p style="text-align: center; color: #2E7D32; padding: 20px 0; font-style: italic;">–î—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç –æ–Ω–ª–∞–π–Ω</p>';
          }
      }

      function addEmoji(emoji) {
          const messageInput = document.getElementById('message');
          messageInput.value += emoji;
          hideElement('emoji-picker');
          messageInput.focus();
      }

      function previewImage(event, previewElementId) {
          const previewElement = document.getElementById(previewElementId);
          if (!previewElement) return;
          const input = event.target;
          const file = input.files ? input.files[0] : null;

          if (file && file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = (e) => {
                  previewElement.src = e.target.result;
                  previewElement.style.display = 'block';
                  if (previewElementId === 'message-preview') {
                      showElement('message-preview-container');
                  }
              }
              reader.readAsDataURL(file);
          } else {
              previewElement.src = '#';
              previewElement.style.display = 'none';
              if (previewElementId === 'message-preview') {
                  hideElement('message-preview-container');
              }
              input.value = '';
          }
      }

      function clearMessagePreview() {
          const previewContainer = document.getElementById('message-preview-container');
          const previewImage = document.getElementById('message-preview');
          const fileInput = document.getElementById('file-input');
          if(previewImage) previewImage.src = '#';
          if(previewContainer) previewContainer.style.display = 'none';
          if(fileInput) fileInput.value = '';
      }

      document.getElementById('new-avatar').onchange = (event) => previewImage(event, 'new-avatar-preview');

      function requestNotificationPermission() {
          if (!('Notification' in window)) {
              console.log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
              return;
          }
          if (Notification.permission === 'default') {
              Notification.requestPermission().then(permission => {
                  if (permission === 'granted') {
                      console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–æ');
                      new Notification('Huiber –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', {
                          body: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!',
                          icon: '/static/logo.png',
                          tag: 'huiber-permission'
                      });
                  } else {
                      console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
                  }
              }).catch(err => {
                  console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:', err);
              });
          }
      }

      function showNotification(title, body, icon) {
          if ('Notification' in window && Notification.permission === 'granted' && document.hidden) {
              const notification = new Notification(title, { body: body, icon: icon || '/static/logo.png', tag: 'huiber-message' });
              setTimeout(notification.close.bind(notification), 7000);
          }
      }

      function openImageModal(src) {
          const modal = document.getElementById('imageModal');
          const modalImg = document.getElementById('modalImage');
          if (modal && modalImg) {
              modalImg.src = src;
              showElement('imageModal');
          }
      }

      function closeImageModal(event) {
          if (!event || event.target.id === 'imageModal' || event.target.classList.contains('close-modal-btn')) {
              const modal = document.getElementById('imageModal');
              const modalImg = document.getElementById('modalImage');
              if (modal && modalImg) {
                  hideElement('imageModal');
                  modalImg.src = '';
              }
              if (event) event.stopPropagation();
          }
      }

      function createPeerConnection() {
          try {
              if (peerConnection) {
                  console.warn("Closing existing peer connection before creating a new one.");
                  cleanUpCall();
              }

              console.log("[Peer] Creating PeerConnection with config:", configuration);
              peerConnection = new RTCPeerConnection(configuration);

              peerConnection.onicecandidate = event => {
                  if (event.candidate && currentTarget && username) {
                      console.log(`[Peer] Sending ICE candidate for ${currentTarget}:`, event.candidate.type, event.candidate.sdpMLineIndex);
                      socket.emit('ice_candidate', {
                          target: currentTarget,
                          candidate: event.candidate,
                          sender: username
                      });
                  } else if (!event.candidate) {
                      console.log("[Peer] All ICE candidates gathered.");
                  } else {
                      console.warn("[Peer] Not sending ICE candidate (no target/username or empty candidate).");
                  }
              };

              peerConnection.ontrack = event => {
                  console.log("[Peer] Track received:", event.track.kind, "Stream:", event.streams[0]?.id);
                  const remoteAudio = document.getElementById('remote-audio');
                  if (remoteAudio && event.streams && event.streams[0]) {
                      console.log("[Peer] Attaching remote stream to audio element.");
                      if (remoteAudio.srcObject !== event.streams[0]) {
                          remoteAudio.srcObject = event.streams[0];
                      } else {
                          console.log("[Peer] Remote stream already attached.");
                      }

                      console.log("[Peer] Attempting to play remote audio...");
                      remoteAudio.play().then(() => {
                          console.log("[Peer] Remote audio playback started successfully.");
                          document.getElementById('call-participants').textContent = `–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ —Å: ${currentTarget || '???'}`;
                          document.getElementById('connecting-indicator').style.display = 'none';
                      }).catch(e => {
                          console.error("[Peer] ERROR playing remote audio:", e);
                          document.getElementById('call-participants').textContent = `–†–∞–∑–≥–æ–≤–æ—Ä —Å ${currentTarget || '???'} (–ø—Ä–æ–±–ª–µ–º–∞ —Å–æ –∑–≤—É–∫–æ–º)`;
                          document.getElementById('connecting-indicator').style.display = 'none';
                      });
                  } else {
                      console.error("[Peer] Failed to attach track: No remoteAudio element or stream available.");
                  }
              };

              peerConnection.oniceconnectionstatechange = () => {
                  if (!peerConnection) return;
                  console.log(`[Peer] >> ICE Connection State Changed: ${peerConnection.iceConnectionState}`);
                  const indicator = document.getElementById('connecting-indicator');
                  const participantsText = document.getElementById('call-participants');
                  const targetName = currentTarget || "—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫";

                  switch(peerConnection.iceConnectionState) {
                      case "new":
                      case "checking":
                          if (indicator) indicator.style.display = 'block';
                          if (participantsText) participantsText.textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${targetName}...`;
                          break;
                      case "connected":
                          if (indicator) indicator.style.display = 'none';
                          console.log("[Peer] ICE connected. Waiting for media stream via 'ontrack'.");
                          break;
                      case "completed":
                          if (indicator) indicator.style.display = 'none';
                          console.log("[Peer] ICE negotiation completed.");
                          break;
                      case "disconnected":
                          if (indicator) indicator.style.display = 'none';
                          if (participantsText) participantsText.textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${targetName} –ø—Ä–µ—Ä–≤–∞–Ω–æ...`;
                          console.warn("[Peer] ICE disconnected.");
                          break;
                      case "failed":
                          if (indicator) indicator.style.display = 'none';
                          if (participantsText) participantsText.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å ${targetName}`;
                          console.error("[Peer] ICE connection failed.");
                          alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${targetName}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.`);
                          endCall();
                          break;
                      case "closed":
                          if (indicator) indicator.style.display = 'none';
                          if (participantsText) participantsText.textContent = `–ó–≤–æ–Ω–æ–∫ —Å ${targetName} –∑–∞–≤–µ—Ä—à–µ–Ω`;
                          console.log("[Peer] ICE connection closed.");
                          cleanUpCall();
                          break;
                      default:
                          if (indicator) indicator.style.display = 'none';
                          break;
                  }
              };

              peerConnection.onsignalingstatechange = () => {
                  if (!peerConnection) return;
                  console.log(`[Peer] >> Signaling State Changed: ${peerConnection.signalingState}`);
              };

              return peerConnection;

          } catch (error) {
              console.error("[Peer] FATAL Error creating PeerConnection:", error);
              alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –±—Ä–∞—É–∑–µ—Ä.");
              return null;
          }
      }

      async function startLocalMedia() {
          console.log("[Media] Requesting user media (audio only)...");
          try {
              localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
              console.log("[Media] Local media stream obtained successfully:", localStream.id);
              return localStream;
          } catch (error) {
              console.error("[Media] ERROR getting user media:", error.name, error.message);
              if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                  alert("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.");
              } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                  alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç.");
              } else {
                  alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ${error.message}`);
              }
              return null;
          }
      }

      async function callUser(targetUsername) {
          console.log(`[CallFlow] Attempting callUser(${targetUsername}) by ${username}`);
          if (!username) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
          if (currentTarget) return alert("–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –∑–≤–æ–Ω–∫–µ –∏–ª–∏ –∑–≤–æ–Ω–∏—Ç–µ.");

          currentTarget = targetUsername;

          localStream = await startLocalMedia();
          if (!localStream) { currentTarget = null; return; }

          peerConnection = createPeerConnection();
          if (!peerConnection) { cleanUpCall(); return; }

          console.log("[CallFlow:Caller] Adding local tracks...");
          localStream.getTracks().forEach(track => {
              try {
                  peerConnection.addTrack(track, localStream);
                  console.log(`[CallFlow:Caller] Local track added: ${track.kind} (${track.id})`);
              } catch (e) {
                  console.error("[CallFlow:Caller] ERROR adding track:", e);
              }
          });

          document.getElementById('call-participants').textContent = `–ó–≤–æ–Ω–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${currentTarget}...`;
          document.getElementById('connecting-indicator').style.display = 'block';
          showElement('call-window');

          try {
              console.log(`[CallFlow:Caller] Creating offer for ${currentTarget}`);
              const offer = await peerConnection.createOffer();
              console.log(`[CallFlow:Caller] Offer created. Setting local description.`);

              try {
                  await peerConnection.setLocalDescription(offer);
                  console.log(`[CallFlow:Caller] Local description (offer) set. Emitting offer to server.`);
                  socket.emit('offer', {
                      offer: peerConnection.localDescription,
                      target: currentTarget,
                      caller: username
                  });
              } catch (e) {
                  console.error(`[CallFlow:Caller] ERROR setting local description (offer):`, e);
                  alert(`–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è: ${e.message}`);
                  endCall();
              }
          } catch (error) {
              console.error("[CallFlow:Caller] ERROR creating offer:", error);
              alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–≤–æ–Ω–∫–∞: ${error.message}`);
              endCall();
          }
      }

      async function acceptCall() {
          console.log(`[CallFlow:Callee] Attempting acceptCall() from ${currentTarget} by ${username}`);
          if (!currentTarget || !receivedOffer) {
              console.error("[CallFlow:Callee] Cannot accept call: Missing target or received offer.");
              rejectCall();
              return;
          }

          hideElement('call-modal');
          ringtone.pause();
          ringtone.currentTime = 0;

          localStream = await startLocalMedia();
          if (!localStream) { rejectCall(); return; }

          peerConnection = createPeerConnection();
          if (!peerConnection) { rejectCall(); return; }

          document.getElementById('call-participants').textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${currentTarget}...`;
          document.getElementById('connecting-indicator').style.display = 'block';
          showElement('call-window');

          console.log("[CallFlow:Callee] Adding local tracks...");
          localStream.getTracks().forEach(track => {
              try {
                  peerConnection.addTrack(track, localStream);
                  console.log(`[CallFlow:Callee] Local track added: ${track.kind} (${track.id})`);
              } catch (e) {
                  console.error("[CallFlow:Callee] ERROR adding track:", e);
              }
          });

          try {
              console.log(`[CallFlow:Callee] Setting remote description (offer) from ${currentTarget}`);
              await peerConnection.setRemoteDescription(new RTCSessionDescription(receivedOffer));
              console.log(`[CallFlow:Callee] Remote description (offer) set. Creating answer.`);
              receivedOffer = null;

              const answer = await peerConnection.createAnswer();
              console.log(`[CallFlow:Callee] Answer created. Setting local description (answer).`);

              try {
                  await peerConnection.setLocalDescription(answer);
                  console.log(`[CallFlow:Callee] Local description (answer) set. Emitting answer to server for ${currentTarget}.`);
                  socket.emit('answer', {
                      answer: peerConnection.localDescription,
                      target: currentTarget,
                      caller: username
                  });
              } catch(e) {
                  console.error(`[CallFlow:Callee] ERROR setting local description (answer):`, e);
                  alert(`–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è (–æ—Ç–≤–µ—Ç–∞): ${e.message}`);
                  endCall();
              }

          } catch (error) {
              console.error("[CallFlow:Callee] ERROR processing offer or creating answer:", error);
              alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–≤–æ–Ω–æ–∫: ${error.message}`);
              endCall();
          }
      }

      function rejectCall() {
          console.log(`[CallFlow] Rejecting call from ${currentTarget} by ${username}`);
          cleanUpCall();
          hideElement('call-modal');
      }

      function endCall() {
          console.log(`[CallFlow] Ending call with ${currentTarget} initiated by ${username}`);
          cleanUpCall();
      }

      function cleanUpCall() {
          console.log("[Cleanup] Starting call cleanup...");
          if (peerConnection) {
              peerConnection.onicecandidate = null;
              peerConnection.ontrack = null;
              peerConnection.oniceconnectionstatechange = null;
              peerConnection.onsignalingstatechange = null;
              if (peerConnection.signalingState !== 'closed') {
                  peerConnection.close();
                  console.log("[Cleanup] PeerConnection closed.");
              }
              peerConnection = null;
          } else {
              console.log("[Cleanup] No active peer connection found.");
          }

          if (localStream) {
              console.log("[Cleanup] Stopping local stream tracks...");
              localStream.getTracks().forEach(track => track.stop());
              localStream = null;
          } else {
              console.log("[Cleanup] No active local stream found.");
          }

          const remoteAudio = document.getElementById('remote-audio');
          if (remoteAudio && remoteAudio.srcObject) {
              console.log("[Cleanup] Stopping remote stream tracks and clearing srcObject...");
              remoteAudio.srcObject = null;
              remoteAudio.pause();
              remoteAudio.removeAttribute('src');
              remoteAudio.load();
          } else {
              console.log("[Cleanup] No active remote stream found on audio element.");
          }

          hideElement('call-window');
          hideElement('call-modal');
          const indicator = document.getElementById('connecting-indicator');
          const participantsText = document.getElementById('call-participants');
          if(indicator) indicator.style.display = 'none';
          if(participantsText) participantsText.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...';

          ringtone.pause();
          ringtone.currentTime = 0;

          console.log(`[Cleanup] Resetting call state (currentTarget was: ${currentTarget})`);
          currentTarget = null;
          receivedOffer = null;
          console.log("[Cleanup] Call cleanup finished.");
      }

      function setupGlobalListeners() {
          console.log("[Socket] Setting up global Socket.IO listeners.");

          socket.off('connect');
          socket.off('disconnect');
          socket.off('reconnect');
          socket.off('connect_error');
          socket.off('initial_messages');
          socket.off('new_message');
          socket.off('message_deleted');
          socket.off('users_list');
          socket.off('update_users');
          socket.off('incoming_call');
          socket.off('offer');
          socket.off('answer');
          socket.off('ice_candidate');

          socket.on('connect', () => {
              console.log(`[Socket] Connected successfully with SID: ${socket.id}`);
              if (username && avatar) {
                  console.log("[Socket] Re-emitting user_active and getting data on connect.");
                  socket.emit('user_active', { username: username, avatar: avatar });
                  socket.emit('get_users');
                  socket.emit('get_messages');
              }
          });

          socket.on('disconnect', (reason) => {
              console.warn(`[Socket] Disconnected: ${reason}`);
              if (currentTarget) {
                  console.warn("[Socket] Cleaning up call state due to disconnection.");
                  cleanUpCall();
                  alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω.");
              }
          });

          socket.on('reconnect', (attemptNumber) => {
              console.log(`[Socket] Reconnected after ${attemptNumber} attempts.`);
          });

          socket.on('connect_error', (err) => {
              console.error("[Socket] Connection error:", err.message);
              if (currentTarget) {
                  console.warn("[Socket] Cleaning up call state due to connection error.");
                  cleanUpCall();
              }
              alert("–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É —á–∞—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
          });

          socket.on('initial_messages', function(loadedMessages) {
              console.log(`[Socket] Received initial_messages (${loadedMessages.messages?.length || 0} messages)`);
              const chat = document.getElementById('chat');
              if (!chat) return;
              chat.innerHTML = '';

              if (loadedMessages.users) {
                  console.log("[Socket] Updating users cache from initial_messages");
                  users = loadedMessages.users;
              }

              if (loadedMessages.messages && loadedMessages.messages.length > 0) {
                  loadedMessages.messages.forEach(msg => renderMessage(msg));
              } else {
                  chat.innerHTML = '<p style="text-align: center; color: #2E7D32; padding: 50px 0; font-style: italic;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...</p>';
              }
              updateMessageStyles();
          });

          socket.on('new_message', function(msg) {
              console.log(`[Socket] Received new_message from ${msg.username} (ID: ${msg.id})`);
              if (msg.username && msg.avatar && (!users[msg.username] || users[msg.username].avatar !== msg.avatar)) {
                  console.log(`[Socket] Updating user cache for ${msg.username} from new_message`);
                  users[msg.username] = { ...(users[msg.username] || {}), avatar: msg.avatar, last_seen: new Date().toISOString() };
              }
              renderMessage(msg);
              if (msg.username !== username) {
                  const avatarSrc = users[msg.username]?.avatar ? `/static/uploads/${users[msg.username].avatar}` : '/static/logo.png';
                  showNotification(
                      `–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${msg.username}`,
                      replaceDenis(msg.text || (msg.image ? "[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]" : "")),
                      avatarSrc
                  );
              }
          });

          socket.on('message_deleted', function(data) {
              console.log(`[Socket] Received message_deleted for ID: ${data.id}`);
              const msgElement = document.querySelector(`.message[data-id="${data.id}"]`);
              if (msgElement) {
                  msgElement.remove();
                  console.log(`[UI] Message element ${data.id} removed.`);
              } else {
                  console.warn(`[UI] Could not find message element ${data.id} to delete.`);
              }
          });

          socket.on('users_list', function(users_data) {
              console.log("[Socket] Received users_list update.");
              users = users_data || {};
              updateUsersList();
              updateMessageStyles();
          });
          socket.on('update_users', function(users_data) {
              console.log("[Socket] Received 'update_users' (legacy?) update.");
              users = users_data || {};
              updateUsersList();
              updateMessageStyles();
          });

          socket.on('incoming_call', function(data) {
              console.log(`[Socket] Received incoming_call from: ${data.caller}`);
              if (currentTarget) {
                  console.warn(`[Socket] Ignoring incoming call from ${data.caller} because already in call with ${currentTarget}.`);
                  return;
              }
              currentTarget = data.caller;
              document.getElementById('call-text').textContent = `–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${currentTarget}`;
              showElement('call-modal');
              ringtone.play().catch(e => console.warn("Ringtone play failed:", e));
          });

          socket.on('offer', async function(data) {
              console.log(`[Socket:${username}] Received 'offer' event from ${data.sender}`);
              if (data.sender === currentTarget) {
                  if (peerConnection && peerConnection.signalingState !== 'stable') {
                      console.warn(`[Socket:${username}] Received offer while P.C. is not stable (${peerConnection.signalingState}). Ignoring.`);
                      return;
                  }
                  console.log(`[Socket:${username}] Storing received offer from ${data.sender}.`);
                  receivedOffer = data.offer;
              } else {
                  console.warn(`[Socket:${username}] Ignoring offer from unexpected sender: ${data.sender}. Expecting: ${currentTarget}`);
              }
          });

          socket.on('answer', async function(data) {
              console.log(`[Socket:${username}] Received 'answer' event from ${data.sender}`);
              if (peerConnection && data.sender === currentTarget) {
                  if (peerConnection.signalingState === 'have-local-offer') {
                      console.log(`[Socket:${username}] Setting remote description (answer) from ${currentTarget}`);
                      try {
                          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                          console.log(`[Socket:${username}] Remote description (answer) set successfully.`);
                      } catch (error) {
                          console.error(`[Socket:${username}] ERROR setting remote description (answer):`, error);
                          alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç ${currentTarget}: ${error.message}`);
                          endCall();
                      }
                  } else {
                      console.warn(`[Socket:${username}] Received answer in unexpected signaling state: ${peerConnection.signalingState}. Ignoring.`);
                  }
              } else {
                  console.warn(`[Socket:${username}] Ignoring answer: PC?(${!!peerConnection}) Sender?(${data.sender} vs ${currentTarget})`);
              }
          });

          socket.on('ice_candidate', async function(data) {
              if (peerConnection && peerConnection.signalingState !== 'closed' && data.sender === currentTarget && data.candidate) {
                  try {
                      await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                  } catch (error) {
                      if (peerConnection && peerConnection.signalingState !== 'closed') {
                          console.warn(`[Socket:${username}] Error adding received ICE candidate:`, error.message);
                      }
                  }
              }
          });
      }

      document.getElementById('message').addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
          }
      });

      document.getElementById('profile-btn').addEventListener('click', function() {
          document.getElementById('new-username').value = username || '';
          const currentAvatarPreview = document.getElementById('new-avatar-preview');
          if (avatar) {
              currentAvatarPreview.src = `/static/uploads/${avatar}`;
              currentAvatarPreview.style.display = 'block';
          } else {
              currentAvatarPreview.style.display = 'none';
              currentAvatarPreview.src = '#';
          }
          showElement('profile-modal');
      });

      document.getElementById('emoji-btn').addEventListener('click', function(event) {
          event.stopPropagation();
          const picker = document.getElementById('emoji-picker');
          picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
      });

      document.addEventListener('click', function(event) {
          const picker = document.getElementById('emoji-picker');
          const emojiBtn = document.getElementById('emoji-btn');
          if (picker && picker.style.display === 'block' && !picker.contains(event.target) && event.target !== emojiBtn) {
              hideElement('emoji-picker');
          }
      });

      window.onload = () => {
          const chat = document.getElementById('chat');
          if(chat) chat.scrollTop = chat.scrollHeight;
      };
    </script>
  </body>
</html>
