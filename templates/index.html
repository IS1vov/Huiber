<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Huiber</title>
    <link rel="icon" type="image/png" href="/static/logo.png" />
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <style>
      body {
          font-family: -apple-system, sans-serif;
          margin: 0;
          background: url('/static/background.png') no-repeat center center fixed;
          background-size: cover;
          display: flex;
          flex-direction: column;
          align-items: center;
          color: #FFFFFF;
      }
      h1 {
          font-size: 28px;
          color: #2E7D32;
          margin: 25px 0;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      h1 button#profile-btn {
          font-size: 16px;
          margin-left: 15px;
          padding: 8px 12px;
          background-color: #A5D6A7;
          color: #2E7D32;
          border: none;
          border-radius: 20px;
          cursor: pointer;
      }
      #chat-container, #username-form, #profile-modal, #users-list {
          width: 100%;
          max-width: 650px;
          background: rgba(255, 255, 255, 0.92);
          border: 1px solid #B0BEC5;
          border-radius: 18px;
          margin-bottom: 20px;
          display: flex;
          flex-direction: column;
      }
      #username-form, #profile-modal {
          padding: 35px;
          text-align: center;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          display: none;
          z-index: 1000;
          max-width: 450px;
      }
      #chat {
          height: 450px;
          overflow-y: auto;
          padding: 20px;
          background: #E8F5E9;
          border-top-left-radius: 18px;
          border-top-right-radius: 18px;
      }
      .message {
          margin-bottom: 12px;
          padding: 10px 15px;
          border-radius: 18px;
          max-width: 78%;
          display: flex;
          align-items: flex-start;
      }
      .my-message {
          background-color: #2E7D32;
          color: white;
          margin-left: auto;
      }
      .other-message {
          background-color: #A5D6A7;
          color: #263238;
          margin-right: auto;
      }
      .avatar {
          width: 35px;
          height: 35px;
          border-radius: 50%;
          margin: 0 10px;
      }
      .message-content-wrapper {
          display: flex;
          flex-direction: column;
          flex-grow: 1;
      }
      .username {
          font-weight: 600;
          font-size: 13px;
          margin-bottom: 3px;
      }
      .message img, .message video {
          max-width: 100%;
          max-height: 300px;
          border-radius: 10px;
          margin-top: 8px;
          cursor: pointer;
      }
      .message .voice-wrapper {
          margin-top: 8px;
          display: flex;
          align-items: center;
      }
      .message audio {
          max-width: 250px;
      }
      .message .voice-duration {
          font-size: 12px;
          margin-left: 10px;
          color: #455A64;
      }
      .delete-btn, .edit-btn {
          background: none;
          border: none;
          color: rgba(255, 255, 255, 0.6);
          position: absolute;
          top: 5px;
          cursor: pointer;
          display: none;
      }
      .delete-btn { right: 8px; }
      .edit-btn { right: 30px; }
      .my-message:hover .delete-btn, .my-message:hover .edit-btn {
          display: block;
      }
      #input-area {
          display: flex;
          padding: 15px 20px;
          background: rgba(255, 255, 255, 0.95);
          border-bottom-left-radius: 18px;
          border-bottom-right-radius: 18px;
      }
      #message {
          flex: 1;
          padding: 12px 18px;
          border: 1px solid #B0BEC5;
          border-radius: 25px;
          outline: none;
          margin-right: 10px;
      }
      #input-area button {
          background: none;
          border: none;
          color: #2E7D32;
          font-size: 24px;
          margin-left: 8px;
          cursor: pointer;
      }
      #record-btn.recording {
          color: #F44336;
      }
      #users-list {
          padding: 20px;
          border-top: 1px solid #E8F5E9;
      }
      .user-item {
          display: flex;
          align-items: center;
          margin-bottom: 12px;
          padding: 10px;
      }
      .user-item img.avatar.online { border: 2px solid #4CAF50; }
      .user-item img.avatar.offline { border: 2px solid #B0BEC5; }
      .user-item .user-info {
          flex-grow: 1;
      }
      .call-user-btn {
          background-color: #4CAF50;
          color: white;
          padding: 8px;
          border-radius: 50%;
          font-size: 18px;
      }
      #ad-banner {
          position: fixed;
          left: 10px;
          top: 50%;
          transform: translateY(-50%);
          width: 200px;
          background: rgba(255, 255, 255, 0.9);
          border: 1px solid #B0BEC5;
          border-radius: 10px;
          padding: 15px;
          text-align: center;
          display: none;
          z-index: 1000;
      }
      #ad-banner img {
          max-width: 100%;
          border-radius: 5px;
          margin-bottom: 10px;
      }
      #ad-banner p {
          color: #2E7D32;
          font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div id="ad-banner">
      <img src="/static/ad_yabloki_i_sosiski.jpg" alt="Yabloki i Sosiski" />
      <p>–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –≤–æ–ª–æ—Å —Å Yabloki i Sosiski!</p>
    </div>
    <h1>Huiber <button id="profile-btn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button></h1>

    <div id="username-form">
      <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è" required />
      <input
        type="file"
        id="avatar"
        accept="image/*"
        style="display: none;"
        required
      />
      <label for="avatar">üì∑ –í—ã–±—Ä–∞—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
      <img
        id="avatar-preview"
        src="#"
        alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"
        style="max-width: 100px; display: none;"
      />
      <button onclick="setUsername()">–í–æ–π—Ç–∏</button>
    </div>

    <div id="profile-modal">
      <input type="text" id="new-username" placeholder="–ù–æ–≤–æ–µ –∏–º—è" />
      <input
        type="file"
        id="new-avatar"
        accept="image/*"
        style="display: none;"
      />
      <label for="new-avatar">üì∑ –°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
      <img
        id="new-avatar-preview"
        src="#"
        alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"
        style="max-width: 100px; display: none;"
      />
      <button onclick="updateProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button
        onclick="document.getElementById('profile-modal').style.display = 'none'"
      >
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>

    <div id="chat-container" style="display: none;">
      <div id="chat"></div>
      <div id="input-area">
        <input type="text" id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <input
          type="file"
          id="file-input"
          accept="image/*,video/*"
          style="display: none;"
          onchange="previewFile(event, 'message-preview')"
        />
        <button onclick="document.getElementById('file-input').click()">
          üì∑
        </button>
        <button id="record-btn">üé§</button>
        <button id="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
      <div id="message-preview-container" style="display: none;">
        <img id="message-preview" src="#" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" />
        <button onclick="clearMessagePreview()">‚úñ</button>
      </div>
    </div>

    <div id="users-list" style="display: none;">
      <h3>üë• –û–Ω–ª–∞–π–Ω</h3>
      <div id="users-content"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script>
      const socket = io();
      let username = localStorage.getItem('username');
      let avatar = localStorage.getItem('avatar');
      let users = {};
      let mediaRecorder;
      let audioChunks = [];

      document.addEventListener('DOMContentLoaded', () => {
          if (!username || !avatar) showLogin();
          else {
              showChat();
              initializeChat();
              checkAdBanner();
          }
      });

      function showLogin() {
          document.getElementById('chat-container').style.display = 'none';
          document.getElementById('users-list').style.display = 'none';
          document.getElementById('username-form').style.display = 'flex';
          document.getElementById('avatar').onchange = (event) => previewFile(event, 'avatar-preview');
      }

      function showChat() {
          document.getElementById('username-form').style.display = 'none';
          document.getElementById('chat-container').style.display = 'flex';
          document.getElementById('users-list').style.display = 'flex';
      }

      function initializeChat() {
          socket.emit('user_active', { username, avatar });
          socket.emit('get_users');
          socket.emit('get_messages');
          setupVoiceRecording();
          document.getElementById('message').addEventListener('keypress', (e) => {
              if (e.key === 'Enter' && !e.shiftKey) {
                  e.preventDefault();
                  sendMessage();
              }
          });
          socket.on('initial_messages', (data) => {
              document.getElementById('chat').innerHTML = '';
              users = data.users || {};
              data.messages.forEach(renderMessage);
              updateMessageStyles();
          });
          socket.on('new_message', (msg) => {
              renderMessage(msg);
          });
          socket.on('message_edited', (data) => {
              const msg = document.querySelector(`.message[data-id="${data.id}"] .message-text`);
              if (msg) msg.textContent = data.text;
          });
          socket.on('message_deleted', (data) => {
              const msg = document.querySelector(`.message[data-id="${data.id}"]`);
              if (msg) msg.remove();
          });
          socket.on('users_list', (data) => {
              users = data;
              updateUsersList();
              updateMessageStyles();
          });
      }

      function setUsername() {
          const usernameInput = document.getElementById('username').value.trim();
          const avatarFile = document.getElementById('avatar').files[0];
          if (usernameInput && avatarFile) {
              const formData = new FormData();
              formData.append('file', avatarFile);
              fetch('/upload', { method: 'POST', body: formData })
                  .then(response => response.text())
                  .then(filename => {
                      username = usernameInput;
                      avatar = filename;
                      localStorage.setItem('username', username);
                      localStorage.setItem('avatar', avatar);
                      showChat();
                      initializeChat();
                      checkAdBanner();
                  })
                  .catch(error => alert(`–û—à–∏–±–∫–∞: ${error.message}`));
          }
      }

      function updateProfile() {
          const newUsername = document.getElementById('new-username').value.trim();
          const newAvatarFile = document.getElementById('new-avatar').files[0];
          let updateData = {};

          if (newUsername && newUsername !== username) {
              updateData.username = newUsername;
          }
          if (newAvatarFile) {
              const formData = new FormData();
              formData.append('file', newAvatarFile);
              fetch('/upload', { method: 'POST', body: formData })
                  .then(response => response.text())
                  .then(filename => {
                      updateData.avatar = filename;
                      finishProfileUpdate(updateData);
                  })
                  .catch(error => alert(`–û—à–∏–±–∫–∞: ${error.message}`));
          } else {
              finishProfileUpdate(updateData);
          }
      }

      function finishProfileUpdate(updateData) {
          if (updateData.username) username = updateData.username;
          if (updateData.avatar) avatar = updateData.avatar;
          localStorage.setItem('username', username);
          localStorage.setItem('avatar', avatar);
          socket.emit('user_active', { username, avatar });
          document.getElementById('profile-modal').style.display = 'none';
          checkAdBanner();
          updateMessageStyles();
          updateUsersList();
      }

      function renderMessage(msg) {
          const chat = document.getElementById('chat');
          if (document.querySelector(`.message[data-id="${msg.id}"]`)) return;
          const div = document.createElement('div');
          div.className = 'message';
          div.dataset.id = msg.id;
          div.dataset.username = msg.username;

          const avatarSrc = users[msg.username]?.avatar ? `/uploads/${users[msg.username].avatar}` : '/static/logo.png';
          let content = '';
          if (msg.text) content += `<span class="message-text">${msg.text}</span>`;
          if (msg.image) content += `<img src="/uploads/${msg.image}" onclick="window.open('/uploads/${msg.image}')">`;
          if (msg.voice) content += `<div class="voice-wrapper"><audio controls src="/uploads/${msg.voice}" preload="metadata" onloadedmetadata="updateVoiceDuration(this)"></audio><span class="voice-duration">0:00</span></div>`;
          if (msg.video) content += `<video controls src="/uploads/${msg.video}"></video>`;

          div.innerHTML = `
              <img src="${avatarSrc}" class="avatar" alt="Avatar">
              <div class="message-content-wrapper">
                  <span class="username">${msg.username}:</span>
                  ${content}
              </div>
              ${msg.username === username ? `
                  <button class="delete-btn" onclick="deleteMessage('${msg.id}')">üóëÔ∏è</button>
                  ${msg.text ? `<button class="edit-btn" onclick="editMessage('${msg.id}', '${msg.text}')">‚úèÔ∏è</button>` : ''}
              ` : ''}
          `;
          chat.appendChild(div);
          updateSingleMessageStyle(div);
          chat.scrollTop = chat.scrollHeight;
      }

      function updateVoiceDuration(audio) {
          const duration = audio.duration;
          if (!isNaN(duration)) {
              const minutes = Math.floor(duration / 60);
              const seconds = Math.floor(duration % 60).toString().padStart(2, '0');
              audio.nextElementSibling.textContent = `${minutes}:${seconds}`;
          }
      }

      function sendMessage() {
          const text = document.getElementById('message').value.trim();
          const file = document.getElementById('file-input').files[0];
          if (text || file) {
              if (file) {
                  const formData = new FormData();
                  formData.append('file', file);
                  fetch('/upload', { method: 'POST', body: formData })
                      .then(response => response.text())
                      .then(filename => {
                          socket.emit('send_message', {
                              username,
                              message: text,
                              [file.type.startsWith('image/') ? 'image' : 'video']: filename
                          });
                          clearMessageInput();
                      })
                      .catch(error => alert(`–û—à–∏–±–∫–∞: ${error.message}`));
              } else {
                  socket.emit('send_message', { username, message: text });
                  clearMessageInput();
              }
          }
      }

      function clearMessageInput() {
          document.getElementById('message').value = '';
          document.getElementById('file-input').value = '';
          document.getElementById('message-preview-container').style.display = 'none';
      }

      function deleteMessage(id) {
          if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) socket.emit('delete_message', { id, username });
      }

      function editMessage(id, text) {
          const newText = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:', text);
          if (newText && newText !== text) socket.emit('edit_message', { id, text: newText, username });
      }

      function setupVoiceRecording() {
          const recordBtn = document.getElementById('record-btn');
          recordBtn.addEventListener('click', () => {
              if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                  navigator.mediaDevices.getUserMedia({ audio: true })
                      .then(stream => {
                          mediaRecorder = new MediaRecorder(stream);
                          audioChunks = [];
                          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                          mediaRecorder.onstop = () => {
                              const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                              const formData = new FormData();
                              formData.append('file', audioBlob, `voice_${Date.now()}.webm`);
                              fetch('/upload', { method: 'POST', body: formData })
                                  .then(response => {
                                      if (!response.ok) throw new Error(response.statusText);
                                      return response.text();
                                  })
                                  .then(filename => socket.emit('send_message', { username, voice: filename }))
                                  .catch(error => alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`));
                              stream.getTracks().forEach(track => track.stop());
                              recordBtn.classList.remove('recording');
                          };
                          mediaRecorder.start();
                          recordBtn.classList.add('recording');
                      })
                      .catch(error => alert('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ' + error.message));
              } else if (mediaRecorder.state === 'recording') {
                  mediaRecorder.stop();
              }
          });
      }

      function updateMessageStyles() {
          document.querySelectorAll('.message').forEach(msg => {
              const isMy = msg.dataset.username === username;
              msg.classList.toggle('my-message', isMy);
              msg.classList.toggle('other-message', !isMy);
          });
      }

      function updateSingleMessageStyle(msg) {
          const isMy = msg.dataset.username === username;
          msg.classList.toggle('my-message', isMy);
          msg.classList.toggle('other-message', !isMy);
      }

      function updateUsersList() {
          const usersContent = document.getElementById('users-content');
          usersContent.innerHTML = '';
          const now = Date.now();
          const onlineThreshold = 60 * 1000;

          Object.entries(users).forEach(([user, info]) => {
              if (user === username) return;
              const div = document.createElement('div');
              div.className = 'user-item';

              const avatarSrc = info.avatar ? `/uploads/${info.avatar}` : '/static/logo.png';
              const lastSeen = parseFloat(info.last_seen || 0);
              const isOnline = now - lastSeen < onlineThreshold;

              div.innerHTML = `
                  <img src="${avatarSrc}" class="avatar ${isOnline ? 'online' : 'offline'}" alt="Avatar">
                  <div class="user-info">
                      <span>${user}</span>
                      <span>${isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}</span>
                  </div>
                  ${isOnline ? `<button class="call-user-btn" onclick="alert('–ó–≤–æ–Ω–∫–∏ –ø–æ–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç')">üìû</button>` : ''}
              `;
              usersContent.appendChild(div);
          });
      }

      function previewFile(event, previewId) {
          const file = event.target.files[0];
          if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                  const preview = document.getElementById(previewId);
                  if (file.type.startsWith('image/')) {
                      preview.outerHTML = `<img id="${previewId}" src="${e.target.result}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">`;
                  } else if (file.type.startsWith('video/')) {
                      preview.outerHTML = `<video id="${previewId}" src="${e.target.result}" controls muted></video>`;
                  }
                  document.getElementById(previewId).style.display = 'block';
                  if (previewId === 'message-preview') document.getElementById('message-preview-container').style.display = 'block';
              };
              reader.readAsDataURL(file);
          }
      }

      function checkAdBanner() {
          document.getElementById('ad-banner').style.display = /–¥–µ|de/i.test(username) ? 'block' : 'none';
      }

      document.getElementById('profile-btn').onclick = () => {
          document.getElementById('new-username').value = username;
          document.getElementById('new-avatar-preview').src = avatar ? `/uploads/${avatar}` : '#';
          document.getElementById('new-avatar-preview').style.display = avatar ? 'block' : 'none';
          document.getElementById('profile-modal').style.display = 'flex';
      };
      document.getElementById('new-avatar').onchange = (e) => previewFile(e, 'new-avatar-preview');
    </script>
  </body>
</html>
